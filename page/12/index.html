<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"swiftist.cn","root":"/","scheme":"Pisces","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"EVBR3H53HW","apiKey":"2abd573a01143a0cc4108fa4d21ae67c","indexName":"swiftist","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="勇于积极进取，步入人生的世外桃源">
<meta property="og:type" content="website">
<meta property="og:title" content="飞雪轩辕">
<meta property="og:url" content="https://swiftist.cn/page/12/index.html">
<meta property="og:site_name" content="飞雪轩辕">
<meta property="og:description" content="勇于积极进取，步入人生的世外桃源">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Andy Ge">
<meta property="article:tag" content="技术博客">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://swiftist.cn/page/12/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>飞雪轩辕</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="飞雪轩辕" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">飞雪轩辕</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">人生的乐趣在于把梦想变成现实</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-java">

    <a href="/categories/java/" rel="section"><i class="fa fa-fw fa-th-large"></i>java</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swiftist.cn/2020/01/15/umi/%E4%BC%A0%E7%BB%9F-Ajax-%E5%B7%B2%E6%AD%BB%EF%BC%8CFetch-%E6%B0%B8%E7%94%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Andy Ge">
      <meta itemprop="description" content="勇于积极进取，步入人生的世外桃源">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="飞雪轩辕">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/15/umi/%E4%BC%A0%E7%BB%9F-Ajax-%E5%B7%B2%E6%AD%BB%EF%BC%8CFetch-%E6%B0%B8%E7%94%9F/" class="post-title-link" itemprop="url">传统 Ajax 已死，Fetch 永生</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-15 09:57:19" itemprop="dateCreated datePublished" datetime="2020-01-15T09:57:19+08:00">2020-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-31 23:07:39" itemprop="dateModified" datetime="2020-03-31T23:07:39+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/umi/" itemprop="url" rel="index">
                    <span itemprop="name">umi</span>
                  </a>
                </span>
            </span>

          
            <span id="/2020/01/15/umi/%E4%BC%A0%E7%BB%9F-Ajax-%E5%B7%B2%E6%AD%BB%EF%BC%8CFetch-%E6%B0%B8%E7%94%9F/" class="post-meta-item leancloud_visitors" data-flag-title="传统 Ajax 已死，Fetch 永生" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Why-Fetch"><a href="#Why-Fetch" class="headerlink" title="Why Fetch"></a>Why Fetch</h2><p>XMLHttpRequest 是一个设计粗糙的 API，不符合关注分离（Separation of Concerns）的原则，配置和调用方式非常混乱，而且基于事件的异步模型写起来也没有现代的 Promise，generator/yield，async/await 友好。</p>
<p>Fetch 的出现就是为了解决 XHR 的问题，拿例子说明：</p>
<p>使用 XHR 发送一个 json 请求一般是这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = newXMLHttpRequest()</span><br><span class="line">xhr.open(<span class="string">'GET'</span>, url)</span><br><span class="line">xhr.responseType = <span class="string">'json'</span></span><br><span class="line"></span><br><span class="line">xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(xhr.response)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">xhr.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Oops, error'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">xhr.send()</span><br></pre></td></tr></table></figure>

<p>使用 Fetch 后，顿时看起来好一点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">fetch(url)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> response.json()</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Oops, error'</span>)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>使用 ES6 的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="noopener">箭头函数</a> 后：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fetch(url)</span><br><span class="line">    .then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">    .then(<span class="function"><span class="params">data</span> =&gt;</span> <span class="built_in">console</span>.log(data))</span><br><span class="line">    .catch(<span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Oops, error'</span>, e))</span><br></pre></td></tr></table></figure>

<p>现在看起来好很多了，但这种 Promise 的写法还是有 Callback 的影子，而且 promise 使用 catch 方法来进行错误处理的方式有点奇怪。不用急，下面使用 async/await 来做最终优化：</p>
<blockquote>
<p>注：async/await 是非常新的 API，属于 ES7，目前尚在 Stage 1(提议) 阶段，这是它的<a href="https://github.com/lukehoban/ecmascript-asyncawait" target="_blank" rel="noopener">完整规范</a>。使用 <a href="https://babeljs.io/" target="_blank" rel="noopener">Babel</a> 开启 <a href="https://babeljs.io/docs/usage/runtime/" target="_blank" rel="noopener">runtime</a> 模式后可以把 async/await 无痛编译成 ES5 代码。也可以直接使用 <a href="https://github.com/facebook/regenerator" target="_blank" rel="noopener">regenerator</a> 来编译到 ES5。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> response = <span class="keyword">await</span> fetch(url)</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> response.json()</span><br><span class="line">    <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Oops, error'</span>, e)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 注：这段代码如果想运行，外面需要包一个 async function</span></span><br></pre></td></tr></table></figure>

<p>duang~~ 的一声，使用 <code>await</code> 后，<strong>写异步代码就像写同步代码一样爽</strong>。<code>await</code> 后面可以跟 Promise 对象，表示等待 Promise <code>resolve()</code> 才会继续向下执行，如果 Promise 被 <code>reject()</code> 或抛出异常则会被外面的 <code>try...catch</code> 捕获。</p>
<p>Promise，generator/yield，await/async 都是现在和未来 JS 解决异步的标准做法，可以完美搭配使用。这也是使用标准 Promise 一大好处。最近也把项目中使用第三方 Promise 库的代码全部转成标准 Promise，为以后全面使用 async/await 做准备。</p>
<p>另外，Fetch 也很适合做现在流行的同构应用，有人基于 Fetch 的语法，在 Node 端基于 http 库实现了 <a href="https://github.com/bitinn/node-fetch" target="_blank" rel="noopener">node-fetch</a>，又有人封装了用于同构应用的 <a href="https://github.com/matthew-andrews/isomorphic-fetch" target="_blank" rel="noopener">isomorphic-fetch</a>。</p>
<blockquote>
<p>注：同构(isomorphic/universal)就是使<strong>前后端运行同一套代码</strong>的意思，后端一般是指 NodeJS 环境。</p>
</blockquote>
<p>总结一下，Fetch 优点主要有：</p>
<ol>
<li>语法简洁，更加语义化</li>
<li>基于标准 Promise 实现，支持 async/await</li>
<li>同构方便，使用 <a href="https://github.com/matthew-andrews/isomorphic-fetch" target="_blank" rel="noopener">isomorphic-fetch</a></li>
</ol>
<h2 id="Fetch-启用方法"><a href="#Fetch-启用方法" class="headerlink" title="Fetch 启用方法"></a>Fetch 启用方法</h2><p>下面是重点 ↓↓↓</p>
<p>先看一下 Fetch 原生支持率：<br><img src="/images/misc/c6e19fc8-6791-11e5-8ac2-bfede76df6b4.png" alt="image"></p>
<p>原生支持率并不高，幸运的是，引入下面这些 polyfill 后可以完美支持 IE8+ ：</p>
<ol>
<li>由于 IE8 是 ES3，需要引入 ES5 的 polyfill: <a href="https://github.com/es-shims/es5-shim" target="_blank" rel="noopener">es5-shim, es5-sham</a></li>
<li>引入 Promise 的 polyfill: <a href="https://github.com/jakearchibald/es6-promise" target="_blank" rel="noopener">es6-promise</a></li>
<li>引入 fetch 探测库：<a href="https://github.com/camsong/fetch-detector" target="_blank" rel="noopener">fetch-detector</a></li>
<li>引入 fetch 的 polyfill: <a href="https://github.com/camsong/fetch-ie8" target="_blank" rel="noopener">fetch-ie8</a></li>
<li>可选：如果你还使用了 jsonp，引入 <a href="https://github.com/camsong/fetch-jsonp" target="_blank" rel="noopener">fetch-jsonp</a></li>
<li>可选：开启 Babel 的 runtime 模式，现在就使用 async/await</li>
</ol>
<p>Fetch polyfill 的基本原理是探测是否存在 <code>window.fetch</code> 方法，如果没有则用 XHR 实现。这也是 <a href="https://github.com/github/fetch" target="_blank" rel="noopener">github/fetch</a> 的做法，但是有些浏览器（Chrome 45）原生支持 Fetch，但响应中有<a href="https://lists.w3.org/Archives/Public/public-webapps-github/2015Aug/0218.html" target="_blank" rel="noopener">中文时会乱码</a>，老外又不太关心这种问题，所以我自己才封装了 <code>fetch-detector</code> 和 <code>fetch-ie8</code> 只在浏览器稳定支持 Fetch 情况下才使用原生 Fetch。这些库现在 <strong>每天有几千万个请求都在使用，绝对靠谱</strong> ！</p>
<p>终于，引用了这一堆 polyfill 后，可以愉快地使用 Fetch 了。但要小心，下面有坑：</p>
<h2 id="Fetch-常见坑"><a href="#Fetch-常见坑" class="headerlink" title="Fetch 常见坑"></a>Fetch 常见坑</h2><ul>
<li>Fetch 请求默认是不带 cookie 的，需要设置 <code>fetch(url, {credentials: &#39;include&#39;})</code></li>
<li>服务器返回 400，500 错误码时并不会 reject，只有网络错误这些导致请求不能完成时，fetch 才会被 reject。</li>
</ul>
<p>竟然没有提到 IE，这实在太不科学了，现在来详细说下 IE</p>
<h2 id="IE-使用策略"><a href="#IE-使用策略" class="headerlink" title="IE 使用策略"></a>IE 使用策略</h2><p>所有版本的 IE 均不支持原生 Fetch，fetch-ie8 会自动使用 XHR 做 polyfill。但在跨域时有个问题需要处理。</p>
<p>IE8, 9 的 XHR 不支持 CORS 跨域，虽然提供 <code>XDomainRequest</code>，但这个东西就是玩具，不支持传 Cookie！如果接口需要权限验证，还是乖乖地使用 jsonp 吧，推荐使用 <a href="https://github.com/camsong/fetch-jsonp" target="_blank" rel="noopener">fetch-jsonp</a>。如果有问题直接提 issue，我会第一时间解决。</p>
<h2 id="Fetch-和标准-Promise-的不足"><a href="#Fetch-和标准-Promise-的不足" class="headerlink" title="Fetch 和标准 Promise 的不足"></a>Fetch 和标准 Promise 的不足</h2><p>由于 Fetch 是典型的异步场景，所以大部分遇到的问题不是 Fetch 的，其实是 Promise 的。ES6 的 Promise 是基于 <a href="https://promisesaplus.com/" target="_blank" rel="noopener">Promises/A+</a> 标准，为了保持 <strong>简单简洁</strong> ，只提供极简的几个 API。如果你用过一些牛 X 的异步库，如 jQuery(不要笑) 、Q.js 或者 RSVP.js，可能会感觉 Promise 功能太少了。</p>
<h3 id="没有-Deferred"><a href="#没有-Deferred" class="headerlink" title="没有 Deferred"></a>没有 Deferred</h3><p><a href="http://api.jquery.com/category/deferred-object/" target="_blank" rel="noopener">Deferred</a> 可以在创建 Promise 时可以减少一层嵌套，还有就是跨方法使用时很方便。<br>ECMAScript 11 年就有过 <a href="http://wiki.ecmascript.org/doku.php?id=strawman:deferred_functions" target="_blank" rel="noopener">Deferred 提案</a>，但后来没被接受。其实用 Promise 不到十行代码就能实现 Deferred：<a href="https://github.com/seangenabe/es6-deferred/blob/master/deferred.js" target="_blank" rel="noopener">es6-deferred</a>。现在有了 async/await，generator/yield 后，deferred 就没有使用价值了。</p>
<h3 id="没有获取状态方法：isRejected，isResolved"><a href="#没有获取状态方法：isRejected，isResolved" class="headerlink" title="没有获取状态方法：isRejected，isResolved"></a>没有获取状态方法：isRejected，isResolved</h3><p>标准 Promise 没有提供获取当前状态 rejected 或者 resolved 的方法。只允许外部传入成功或失败后的回调。我认为这其实是优点，这是一种声明式的接口，更简单。</p>
<h3 id="缺少其它一些方法：always，progress，finally"><a href="#缺少其它一些方法：always，progress，finally" class="headerlink" title="缺少其它一些方法：always，progress，finally"></a>缺少其它一些方法：always，progress，finally</h3><p>always 可以通过在 then 和 catch 里重复调用方法实现。finally 也类似。progress 这种进度通知的功能还没有用过，暂不知道如何替代。</p>
<h3 id="不能中断，没有-abort、terminate、onTimeout-或-cancel-方法"><a href="#不能中断，没有-abort、terminate、onTimeout-或-cancel-方法" class="headerlink" title="不能中断，没有 abort、terminate、onTimeout 或 cancel 方法"></a>不能中断，没有 abort、terminate、onTimeout 或 cancel 方法</h3><p>Fetch 和 Promise 一样，一旦发起，不能中断，也不会超时，只能等待被 resolve 或 reject。幸运的是，whatwg 目前正在尝试解决这个问题 <a href="https://github.com/whatwg/fetch/issues/27" target="_blank" rel="noopener">whatwg/fetch#27</a></p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ul>
<li><a href="https://fetch.spec.whatwg.org/" target="_blank" rel="noopener">WHATWG Fetch 规范</a></li>
<li><a href="http://bubkoo.com/2015/05/08/introduction-to-fetch/" target="_blank" rel="noopener">Fetch API 简介</a></li>
<li><a href="http://pouchdb.com/2015/03/05/taming-the-async-beast-with-es7.html" target="_blank" rel="noopener">教你驯服 async</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2015/05/async.html" target="_blank" rel="noopener">阮一峰介绍 async</a></li>
</ul>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>Fetch 替换 XHR 只是时间问题，现在看到国外很多新的库都默认使用了 Fetch。</p>
<p>最后再做一个大胆预测：由于 async/await 这类新异步语法的出现，第三方的 Promise 类库会逐渐被标准 Promise 替代，使用 polyfill 是现在比较明智的做法。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swiftist.cn/2020/01/15/umi/umi-request/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Andy Ge">
      <meta itemprop="description" content="勇于积极进取，步入人生的世外桃源">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="飞雪轩辕">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/15/umi/umi-request/" class="post-title-link" itemprop="url">umi-request</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-15 08:19:44" itemprop="dateCreated datePublished" datetime="2020-01-15T08:19:44+08:00">2020-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-31 23:07:39" itemprop="dateModified" datetime="2020-03-31T23:07:39+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/umi/" itemprop="url" rel="index">
                    <span itemprop="name">umi</span>
                  </a>
                </span>
            </span>

          
            <span id="/2020/01/15/umi/umi-request/" class="post-meta-item leancloud_visitors" data-flag-title="umi-request" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="umi-request"><a href="#umi-request" class="headerlink" title="umi-request"></a>umi-request</h1><p>网络请求库，基于 fetch 封装, 兼具 fetch 与 axios 的特点, 旨在为开发者提供一个统一的 api 调用方式, 简化使用, 并提供诸如缓存, 超时, 字符编码处理, 错误处理等常用功能.</p>
<hr>
<h2 id="支持的功能"><a href="#支持的功能" class="headerlink" title="支持的功能"></a>支持的功能</h2><ul>
<li>url 参数自动序列化</li>
<li>post 数据提交方式简化</li>
<li>response 返回处理简化</li>
<li>api 超时支持</li>
<li>api 请求缓存支持</li>
<li>支持处理 gbk</li>
<li>类 axios 的 request 和 response 拦截器(interceptors)支持</li>
<li>统一的错误处理方式</li>
<li>类 koa 洋葱机制的 use 中间件机制支持</li>
<li>类 axios 的取消请求</li>
<li>支持 node 环境发送 http 请求</li>
</ul>
<h2 id="与-fetch-axios-异同"><a href="#与-fetch-axios-异同" class="headerlink" title="与 fetch, axios 异同"></a>与 fetch, axios 异同</h2><table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">umi-request</th>
<th align="left">fetch</th>
<th align="left">axios</th>
</tr>
</thead>
<tbody><tr>
<td align="left">实现</td>
<td align="left">浏览器原生支持</td>
<td align="left">浏览器原生支持</td>
<td align="left">XMLHttpRequest</td>
</tr>
<tr>
<td align="left">大小</td>
<td align="left">9k</td>
<td align="left">4k (polyfill)</td>
<td align="left">14k</td>
</tr>
<tr>
<td align="left">query 简化</td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">✅</td>
</tr>
<tr>
<td align="left">post 简化</td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">❌</td>
</tr>
<tr>
<td align="left">超时</td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">✅</td>
</tr>
<tr>
<td align="left">缓存</td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">❌</td>
</tr>
<tr>
<td align="left">错误检查</td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">❌</td>
</tr>
<tr>
<td align="left">错误处理</td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">✅</td>
</tr>
<tr>
<td align="left">拦截器</td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">✅</td>
</tr>
<tr>
<td align="left">前缀</td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">❌</td>
</tr>
<tr>
<td align="left">后缀</td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">❌</td>
</tr>
<tr>
<td align="left">处理 gbk</td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">❌</td>
</tr>
<tr>
<td align="left">中间件</td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">❌</td>
</tr>
<tr>
<td align="left">取消请求</td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">✅</td>
</tr>
</tbody></table>
<p>更多讨论参考<a href="https://github.com/camsong/blog/issues/2" target="_blank" rel="noopener">传统 Ajax 已死，Fetch 永生</a>, 如果你有好的建议和需求, 请提 <a href="https://github.com/umijs/umi/issues" target="_blank" rel="noopener">issue</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save umi-request</span><br></pre></td></tr></table></figure>

<h2 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h2><p>执行 <strong>GET</strong> 请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'umi-request'</span></span><br><span class="line"></span><br><span class="line">request</span><br><span class="line">    .get(<span class="string">'/api/v1/xxx?id=1'</span>)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可将 URL 的参数放到 options.params 里</span></span><br><span class="line">request</span><br><span class="line">    .get(<span class="string">'/api/v1/xxx'</span>, &#123;</span><br><span class="line">        params: &#123;</span><br><span class="line">            id: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>执行 <strong>POST</strong> 请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .post(<span class="string">'/api/v1/user'</span>, &#123;</span><br><span class="line">        data: &#123;</span><br><span class="line">            name: <span class="string">'Mike'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="umi-request-API"><a href="#umi-request-API" class="headerlink" title="umi-request API"></a>umi-request API</h2><p>可以通过向 <strong>umi-request</strong> 传参来发起请求</p>
<p><strong>umi-request(url[, options])</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'umi-request'</span></span><br><span class="line"></span><br><span class="line">request(<span class="string">'/api/v1/xxx'</span>, &#123;</span><br><span class="line">    method: <span class="string">'get'</span>,</span><br><span class="line">    params: &#123; <span class="attr">id</span>: <span class="number">1</span> &#125;</span><br><span class="line">&#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">request(<span class="string">'/api/v1/user'</span>, &#123;</span><br><span class="line">    method: <span class="string">'post'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        name: <span class="string">'Mike'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="请求方法的别名"><a href="#请求方法的别名" class="headerlink" title="请求方法的别名"></a>请求方法的别名</h2><p>为了方便起见，为所有支持的请求方法提供了别名, <code>method</code> 属性不必在配置中指定</p>
<p><strong>request.get(url[, options])</strong></p>
<p><strong>request.post(url[, options])</strong></p>
<p><strong>request.delete(url[, options])</strong></p>
<p><strong>request.put(url[, options])</strong></p>
<p><strong>request.patch(url[, options])</strong></p>
<p><strong>request.head(url[, options])</strong></p>
<p><strong>request.options(url[, options])</strong></p>
<h2 id="创建实例"><a href="#创建实例" class="headerlink" title="创建实例"></a>创建实例</h2><p>有些通用的配置我们不想每个请求里都去添加，那么可以通过 <code>extend</code> 新建一个 umi-request 实例</p>
<p><strong>extend([options])</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; extend &#125; <span class="keyword">from</span> <span class="string">'umi-request'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> request = extend(&#123;</span><br><span class="line">    prefix: <span class="string">'/api/v1'</span>,</span><br><span class="line">    timeout: <span class="number">1000</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'multipart/form-data'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">request</span><br><span class="line">    .get(<span class="string">'/user'</span>)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>NodeJS 环境创建实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> umi = <span class="built_in">require</span>(<span class="string">'umi-request'</span>)</span><br><span class="line"><span class="keyword">const</span> extendRequest = umi.extend(&#123; <span class="attr">timeout</span>: <span class="number">10000</span> &#125;)</span><br><span class="line"></span><br><span class="line">extendRequest(<span class="string">'/api/user'</span>)</span><br><span class="line">    .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>以下是可用的实例方法，指定的配置将与实例的配置合并。</p>
<p><strong>request.get(url[, options])</strong></p>
<p><strong>request.post(url[, options])</strong></p>
<p><strong>request.delete(url[, options])</strong></p>
<p><strong>request.put(url[, options])</strong></p>
<p><strong>request.patch(url[, options])</strong></p>
<p><strong>request.head(url[, options])</strong></p>
<p><strong>request.options(url[, options])</strong></p>
<p>umi-request 可以进行一层简单封装后再使用, 可参考 <a href="https://github.com/umijs/ant-design-pro/blob/master/src/utils/request.js" target="_blank" rel="noopener">antd-pro</a></p>
<h2 id="请求配置"><a href="#请求配置" class="headerlink" title="请求配置"></a>请求配置</h2><h3 id="request-options-参数"><a href="#request-options-参数" class="headerlink" title="request options 参数"></a>request options 参数</h3><table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
<th align="left">类型</th>
<th align="left">可选值</th>
<th align="left">默认值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">method</td>
<td align="left">请求方式</td>
<td align="left">string</td>
<td align="left">get , post , put …</td>
<td align="left">get</td>
</tr>
<tr>
<td align="left">params</td>
<td align="left">url 请求参数</td>
<td align="left">object 或 URLSearchParams 对象</td>
<td align="left">–</td>
<td align="left">–</td>
</tr>
<tr>
<td align="left">data</td>
<td align="left">提交的数据</td>
<td align="left">any</td>
<td align="left">–</td>
<td align="left">–</td>
</tr>
<tr>
<td align="left">headers</td>
<td align="left">fetch 原有参数</td>
<td align="left">object</td>
<td align="left">–</td>
<td align="left">{}</td>
</tr>
<tr>
<td align="left">timeout</td>
<td align="left">超时时长, 默认毫秒, 写操作慎用</td>
<td align="left">number</td>
<td align="left">–</td>
<td align="left">–</td>
</tr>
<tr>
<td align="left">prefix</td>
<td align="left">前缀, 一般用于覆盖统一设置的 prefix</td>
<td align="left">string</td>
<td align="left">–</td>
<td align="left">–</td>
</tr>
<tr>
<td align="left">suffix</td>
<td align="left">后缀, 比如某些场景 api 需要统一加 .json</td>
<td align="left">string</td>
<td align="left">–</td>
<td align="left">–</td>
</tr>
<tr>
<td align="left">credentials</td>
<td align="left">fetch 请求包含 cookies 信息</td>
<td align="left">string</td>
<td align="left">–</td>
<td align="left">credentials: ‘same-origin’</td>
</tr>
<tr>
<td align="left">useCache</td>
<td align="left">是否使用缓存（仅支持浏览器客户端）</td>
<td align="left">boolean</td>
<td align="left">–</td>
<td align="left">false</td>
</tr>
<tr>
<td align="left">validateCache</td>
<td align="left">缓存策略函数</td>
<td align="left">(url, options) =&gt; boolean</td>
<td align="left">–</td>
<td align="left">默认 get 请求做缓存</td>
</tr>
<tr>
<td align="left">ttl</td>
<td align="left">缓存时长, 0 为不过期</td>
<td align="left">number</td>
<td align="left">–</td>
<td align="left">60000</td>
</tr>
<tr>
<td align="left">maxCache</td>
<td align="left">最大缓存数</td>
<td align="left">number</td>
<td align="left">–</td>
<td align="left">无限</td>
</tr>
<tr>
<td align="left">requestType</td>
<td align="left">post 请求时数据类型</td>
<td align="left">string</td>
<td align="left">json , form</td>
<td align="left">json</td>
</tr>
<tr>
<td align="left">parseResponse</td>
<td align="left">是否对 response 做处理简化</td>
<td align="left">boolean</td>
<td align="left">–</td>
<td align="left">true</td>
</tr>
<tr>
<td align="left">charset</td>
<td align="left">字符集</td>
<td align="left">string</td>
<td align="left">utf8 , gbk</td>
<td align="left">utf8</td>
</tr>
<tr>
<td align="left">responseType</td>
<td align="left">如何解析返回的数据</td>
<td align="left">string</td>
<td align="left">json , text , blob , formData …</td>
<td align="left">json , text</td>
</tr>
<tr>
<td align="left">throwErrIfParseFail</td>
<td align="left">当 responseType 为 ‘json’, 对请求结果做 JSON.parse 出错时是否抛出异常</td>
<td align="left">boolean</td>
<td align="left">–</td>
<td align="left">false</td>
</tr>
<tr>
<td align="left">getResponse</td>
<td align="left">是否获取源 response, 返回结果将包裹一层</td>
<td align="left">boolean</td>
<td align="left">–</td>
<td align="left">fasle</td>
</tr>
<tr>
<td align="left">errorHandler</td>
<td align="left">异常处理, 或者覆盖统一的异常处理</td>
<td align="left">function(error)</td>
<td align="left">–</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">cancelToken</td>
<td align="left">取消请求的 Token</td>
<td align="left">CancelToken.token</td>
<td align="left">–</td>
<td align="left">–</td>
</tr>
</tbody></table>
<p>fetch 原其他参数有效, 详见<a href="https://github.github.io/fetch/" target="_blank" rel="noopener">fetch 文档</a></p>
<h3 id="extend-options-初始化默认参数-支持以上所有"><a href="#extend-options-初始化默认参数-支持以上所有" class="headerlink" title="extend options 初始化默认参数, 支持以上所有"></a>extend options 初始化默认参数, 支持以上所有</h3><table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">说明</th>
<th align="left">类型</th>
<th align="left">可选值</th>
<th align="left">默认值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">method</td>
<td align="left">请求方式</td>
<td align="left">string</td>
<td align="left">get , post , put …</td>
<td align="left">get</td>
</tr>
<tr>
<td align="left">params</td>
<td align="left">url 请求参数</td>
<td align="left">object</td>
<td align="left">–</td>
<td align="left">–</td>
</tr>
<tr>
<td align="left">data</td>
<td align="left">提交的数据</td>
<td align="left">any</td>
<td align="left">–</td>
<td align="left">–</td>
</tr>
</tbody></table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 'method' 是创建请求时使用的方法</span></span><br><span class="line">  method: <span class="string">'get'</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'params' 是即将于请求一起发送的 URL 参数，参数会自动 encode 后添加到 URL 中</span></span><br><span class="line">  <span class="comment">// 类型需为 Object 对象或者 URLSearchParams 对象</span></span><br><span class="line">  params: &#123; <span class="attr">id</span>: <span class="number">1</span> &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'paramsSerializer' 开发者可通过该函数对 params 做序列化（注意：此时传入的 params 为合并了 extends 中 params 参数的对象，如果传入的是 URLSearchParams 对象会转化为 Object 对象</span></span><br><span class="line">  paramsSerializer: <span class="function"><span class="keyword">function</span> (<span class="params">params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Qs.stringify(params, &#123; <span class="attr">arrayFormat</span>: <span class="string">'brackets'</span> &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'data' 作为请求主体被发送的数据</span></span><br><span class="line">  <span class="comment">// 适用于这些请求方法 'PUT', 'POST', 和 'PATCH'</span></span><br><span class="line">  <span class="comment">// 必须是以下类型之一：</span></span><br><span class="line">  <span class="comment">// - string, plain object, ArrayBuffer, ArrayBufferView, URLSearchParams</span></span><br><span class="line">  <span class="comment">// - 浏览器专属：FormData, File, Blob</span></span><br><span class="line">  <span class="comment">// - Node 专属： Stream</span></span><br><span class="line">  data: &#123; <span class="attr">name</span>: <span class="string">'Mike'</span> &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'headers' 请求头</span></span><br><span class="line">  headers: &#123; <span class="string">'Content-Type'</span>: <span class="string">'multipart/form-data'</span> &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'timeout' 指定请求超时的毫秒数（0 表示无超时时间）</span></span><br><span class="line">  <span class="comment">// 如果请求超过了 'timeout' 时间，请求将被中断并抛出请求异常</span></span><br><span class="line">  timeout: <span class="number">1000</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ’prefix‘ 前缀，统一设置 url 前缀</span></span><br><span class="line">  <span class="comment">// ( e.g. request('/user/save', &#123; prefix: '/api/v1' &#125;) =&gt; request('/api/v1/user/save') )</span></span><br><span class="line">  prefix: <span class="string">''</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ’suffix‘ 后缀，统一设置 url 后缀</span></span><br><span class="line">  <span class="comment">// ( e.g. request('/api/v1/user/save', &#123; suffix: '.json'&#125;) =&gt; request('/api/v1/user/save.json') )</span></span><br><span class="line">  suffix: <span class="string">''</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'credentials' 发送带凭据的请求</span></span><br><span class="line">  <span class="comment">// 为了让浏览器发送包含凭据的请求（即使是跨域源），需要设置 credentials: 'include'</span></span><br><span class="line">  <span class="comment">// 如果只想在请求URL与调用脚本位于同一起源处时发送凭据，请添加credentials: 'same-origin'</span></span><br><span class="line">  <span class="comment">// 要改为确保浏览器不在请求中包含凭据，请使用credentials: 'omit'</span></span><br><span class="line">  credentials: <span class="string">'same-origin'</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ’useCache‘ 是否使用缓存，当值为 true 时，GET 请求在 ttl 毫秒内将被缓存，缓存策略唯一 key 为 url + params + method 组合</span></span><br><span class="line">  useCache: <span class="literal">false</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ’ttl‘ 缓存时长（毫秒）， 0 为不过期</span></span><br><span class="line">  ttl: <span class="number">60000</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'maxCache' 最大缓存数， 0 为无限制</span></span><br><span class="line">  maxCache: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据协议规范， GET 请求用于获取、查询服务端数据，在数据更新频率不频繁的情况下做必要的缓存能减少服务端的压力，因为缓存策略是默认对 GET 请求做缓存，但对于一些特殊场景需要缓存其他类型请求的响应数据时，我们提供 validateCache 供用户自定义何时需要进行缓存， key 依旧为 url + params + method</span></span><br><span class="line">  validateCache: <span class="function">(<span class="params">url, options</span>) =&gt;</span> &#123; <span class="keyword">return</span> options.method.toLowerCase() === <span class="string">'get'</span> &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'requestType' 当 data 为对象或者数组时， umi-request 会根据 requestType 动态添加 headers 和设置 body（可传入 headers 覆盖 Accept 和 Content-Type 头部属性）:</span></span><br><span class="line">  <span class="comment">// 1. requestType === 'json' 时, (默认为 json )</span></span><br><span class="line">  <span class="comment">// options.headers = &#123;</span></span><br><span class="line">  <span class="comment">//   Accept: 'application/json',</span></span><br><span class="line">  <span class="comment">//   'Content-Type': 'application/json;charset=UTF-8',</span></span><br><span class="line">  <span class="comment">//   ...options.headers,</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="comment">// options.body = JSON.stringify(data)</span></span><br><span class="line">  <span class="comment">// 2. requestType === 'form' 时，</span></span><br><span class="line">  <span class="comment">// options.headers = &#123;</span></span><br><span class="line">  <span class="comment">//   Accept: 'application/json',</span></span><br><span class="line">  <span class="comment">//   'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',</span></span><br><span class="line">  <span class="comment">//   ...options.headers,</span></span><br><span class="line">  <span class="comment">// &#125;;</span></span><br><span class="line">  <span class="comment">// options.body = query-string.stringify(data);</span></span><br><span class="line">  <span class="comment">// 3. 其他 requestType</span></span><br><span class="line">  <span class="comment">// options.headers = &#123;</span></span><br><span class="line">  <span class="comment">//   Accept: 'application/json',</span></span><br><span class="line">  <span class="comment">//   ...options.headers,</span></span><br><span class="line">  <span class="comment">// &#125;;</span></span><br><span class="line">  <span class="comment">// options.body = data;</span></span><br><span class="line">  requestType: <span class="string">'json'</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ’parseResponse‘ 是否对请求返回的 Response 对象做格式、状态码解析</span></span><br><span class="line">  parseResponse: <span class="literal">true</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ’charset‘ 当服务端返回的数据编码类型为 gbk 时可使用该参数，umi-request 会按 gbk 编码做解析，避免得到乱码, 默认为 utf8</span></span><br><span class="line">  <span class="comment">// 当 parseResponse 值为 false 时该参数无效</span></span><br><span class="line">  charset: <span class="string">'gbk'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'responseType': 如何解析返回的数据，当 parseResponse 值为 false 时该参数无效</span></span><br><span class="line">  <span class="comment">// 默认为 'json', 对返回结果进行 Response.text().then( d =&gt; JSON.parse(d) ) 解析</span></span><br><span class="line">  <span class="comment">// 其他(text, blob, arrayBuffer, formData), 做 Response[responseType]() 解析</span></span><br><span class="line">  responseType: <span class="string">'json'</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'throwErrIfParseFail': 当 responseType 为 json 但 JSON.parse(data) fail 时，是否抛出异常。默认不抛出异常而返回 Response.text() 后的结果，如需要抛出异常，可设置 throwErrIfParseFail 为 true</span></span><br><span class="line">  throwErrIfParseFail: <span class="literal">false</span>, <span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'getResponse': 是否获取源 Response， 返回结果将包含一层： &#123; data, response &#125;</span></span><br><span class="line">  getResponse: <span class="literal">false</span>,<span class="comment">// default</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'errorHandler' 统一的异常处理，供开发者对请求发生的异常做统一处理，详细使用请参考下方的错误处理文档</span></span><br><span class="line">  errorHandler: <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123; <span class="comment">/* 异常处理 */</span> &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'cancelToken' 取消请求的 Token，详细使用请参考下方取消请求文档</span></span><br><span class="line">  cancelToken: <span class="literal">null</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="更新拓展实例默认参数"><a href="#更新拓展实例默认参数" class="headerlink" title="更新拓展实例默认参数"></a>更新拓展实例默认参数</h3><p>实例化一个请求实例后，有时还需要动态更新默认参数，umi-request 提供 <strong>extendOptions</strong> 方法供用户进行更新：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> request = extend(&#123; <span class="attr">timeout</span>: <span class="number">1000</span>, <span class="attr">params</span>: &#123; <span class="attr">a</span>: <span class="string">'1'</span> &#125; &#125;)</span><br><span class="line"><span class="comment">// 默认参数是 &#123; timeout: 1000, params: &#123; a: '1' &#125;&#125;</span></span><br><span class="line"></span><br><span class="line">request.extendOptions(&#123; <span class="attr">timeout</span>: <span class="number">3000</span>, <span class="attr">params</span>: &#123; <span class="attr">b</span>: <span class="string">'2'</span> &#125; &#125;)</span><br><span class="line"><span class="comment">// 此时默认参数是 &#123; timeout: 3000, params: &#123; a: '1', b: '2' &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="响应结构"><a href="#响应结构" class="headerlink" title="响应结构"></a>响应结构</h2><p>某个请求的响应返回的响应对象 Response 如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// `data` 由服务器提供的响应, 需要进行解析才能获取</span></span><br><span class="line">  data: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `status` 来自服务器响应的 HTTP 状态码</span></span><br><span class="line">  status: <span class="number">200</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `statusText` 来自服务器响应的 HTTP 状态信息</span></span><br><span class="line">  statusText: <span class="string">'OK'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `headers` 服务器响应的头</span></span><br><span class="line">  headers: &#123;&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 options.getResponse === false 时, 响应结构为解析后的 data</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.get(<span class="string">'/api/v1/xxx'</span>, &#123; <span class="attr">getResponse</span>: <span class="literal">false</span> &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>当 options.getResponse === true 时，响应结构为包含 data 和 Response 的对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .get(<span class="string">'/api/v1/xxx'</span>, &#123; <span class="attr">getResponse</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">&#123; data, response &#125;</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data)</span><br><span class="line">        <span class="built_in">console</span>.log(response.status)</span><br><span class="line">        <span class="built_in">console</span>.log(response.statusText)</span><br><span class="line">        <span class="built_in">console</span>.log(response.headers)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>在使用 catch 或者 errorHandler, 响应对象可以通过 <code>error</code> 对象获取使用，参考<strong>错误处理</strong>这一节文档。</p>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request, &#123; extend &#125; <span class="keyword">from</span> <span class="string">'umi-request'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> errorHandler = <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> codeMap = &#123;</span><br><span class="line">        <span class="string">'021'</span>: <span class="string">'发生错误啦'</span>,</span><br><span class="line">        <span class="string">'022'</span>: <span class="string">'发生大大大大错误啦'</span></span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (error.response) &#123;</span><br><span class="line">        <span class="comment">// 请求已发送但服务端返回状态码非 2xx 的响应</span></span><br><span class="line">        <span class="built_in">console</span>.log(error.response.status)</span><br><span class="line">        <span class="built_in">console</span>.log(error.response.headers)</span><br><span class="line">        <span class="built_in">console</span>.log(error.data)</span><br><span class="line">        <span class="built_in">console</span>.log(error.request)</span><br><span class="line">        <span class="built_in">console</span>.log(codeMap[error.data.status])</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 请求初始化时出错或者没有响应返回的异常</span></span><br><span class="line">        <span class="built_in">console</span>.log(error.message)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> error <span class="comment">// 如果throw. 错误将继续抛出.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果return, 则将值作为返回. 'return;' 相当于return undefined, 在处理结果时判断response是否有值即可.</span></span><br><span class="line">    <span class="comment">// return &#123;some: 'data'&#125;;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 作为统一错误处理</span></span><br><span class="line"><span class="keyword">const</span> extendRequest = extend(&#123; errorHandler &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 单独特殊处理, 如果配置了统一处理, 但某个api需要特殊处理. 则在请求时, 将errorHandler作为参数传入.</span></span><br><span class="line">request(<span class="string">'/api/v1/xxx'</span>, &#123; errorHandler &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 通过 Promise.catch 做错误处理</span></span><br><span class="line">request(<span class="string">'/api/v1/xxx'</span>)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> errorHandler(error)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><p>类 koa 的洋葱机制，让开发者优雅地做请求前后的增强处理，支持创建实例、全局、内核中间件。</p>
<p><strong>实例中间件（默认）</strong> ：request.use(fn) 不同实例创建的中间件相互独立不影响;</p>
<p><strong>全局中间件</strong> : request.use(fn, { global: true }) 全局中间件，不同实例共享全局中间件；</p>
<p><strong>内核中间件</strong> ：request.use(fn, { core: true }) 内核中间件， 方便开发者拓展请求内核；</p>
<p>request.use(fn[, options])</p>
<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><p>fn 入参</p>
<ul>
<li>ctx(Object)：上下文对象，包括 req 和 res 对象</li>
<li>next(Function)：调用下一个中间件的函数</li>
</ul>
<p>options 参数</p>
<ul>
<li>global(boolean): 是否为全局中间件，优先级比 core 高</li>
<li>core(boolean): 是否为内核中间件</li>
</ul>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><ol>
<li>同类型中间件执行顺序</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request, &#123; extend &#125; <span class="keyword">from</span> <span class="string">'umi-request'</span></span><br><span class="line">request.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'a1'</span>)</span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'a2'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">request.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'b1'</span>)</span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'b2'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> request(<span class="string">'/api/v1/a'</span>)</span><br></pre></td></tr></table></figure>

<p>执行顺序如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a1 -&gt; b1 -&gt; response -&gt; b2 -&gt; a2</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>不同类型中间件执行顺序</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">request.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'instanceA1'</span>)</span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'instanceA2'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">request.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'instanceB1'</span>)</span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'instanceB2'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">request.use(</span><br><span class="line">    <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'globalA1'</span>)</span><br><span class="line">        <span class="keyword">await</span> next()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'globalA2'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">global</span>: <span class="literal">true</span> &#125;</span><br><span class="line">)</span><br><span class="line">request.use(</span><br><span class="line">    <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'coreA1'</span>)</span><br><span class="line">        <span class="keyword">await</span> next()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'coreA2'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">core</span>: <span class="literal">true</span> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>执行顺序如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">instanceA1 -&gt; instanceB1 -&gt; globalA1 -&gt; coreA1 -&gt; coreA2 -&gt; globalA2 -&gt; instanceB2 -&gt; instanceA2</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用中间件对请求前后做处理</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">request.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; req &#125; = ctx</span><br><span class="line">    <span class="keyword">const</span> &#123; url, options &#125; = req</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否需要添加前缀，如果是统一添加可通过 prefix、suffix 参数配置</span></span><br><span class="line">    <span class="keyword">if</span> (url.indexOf(<span class="string">'/api'</span>) !== <span class="number">0</span>) &#123;</span><br><span class="line">        ctx.req.url = <span class="string">`/api/v1/<span class="subst">$&#123;url&#125;</span>`</span></span><br><span class="line">    &#125;</span><br><span class="line">    ctx.req.options = &#123;</span><br><span class="line">        ...options,</span><br><span class="line">        foo: <span class="string">'foo'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; res &#125; = ctx</span><br><span class="line">    <span class="keyword">const</span> &#123; success = <span class="literal">false</span> &#125; = res <span class="comment">// 假设返回结果为 : &#123; success: false, errorCode: 'B001' &#125;</span></span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">// 对异常情况做对应处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用内核中间件拓展请求能力</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">request.use(</span><br><span class="line">    <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; req &#125; = ctx</span><br><span class="line">        <span class="keyword">const</span> &#123; url, options &#125; = req</span><br><span class="line">        <span class="keyword">const</span> &#123; __umiRequestCoreType__ = <span class="string">'normal'</span> &#125; = options</span><br><span class="line"></span><br><span class="line">        <span class="comment">// __umiRequestCoreType__ 用于区分请求内核类型</span></span><br><span class="line">        <span class="comment">// 值为 'normal' 使用 umi-request 内置的请求内核</span></span><br><span class="line">        <span class="keyword">if</span> (__umiRequestCoreType__ === <span class="string">'normal'</span>) &#123;</span><br><span class="line">            <span class="keyword">await</span> next()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 非 normal 使用自定义请求内核获取响应数据</span></span><br><span class="line">        <span class="keyword">const</span> response = getResponseByOtherWay()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将响应数据写入 ctx 中</span></span><br><span class="line">        ctx.res = response</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> next()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">core</span>: <span class="literal">true</span> &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用自定义请求内核</span></span><br><span class="line">request(<span class="string">'/api/v1/rpc'</span>, &#123;</span><br><span class="line">    __umiRequestCoreType__: <span class="string">'rpc'</span>,</span><br><span class="line">    parseResponse: <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><p>在请求或响应被 <code>then</code> 或 <code>catch</code> 处理前拦截它们。</p>
<ol>
<li>全局拦截器</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request拦截器, 改变url 或 options.</span></span><br><span class="line">request.interceptors.request.use(<span class="function">(<span class="params">url, options</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        url: <span class="string">`<span class="subst">$&#123;url&#125;</span>&amp;interceptors=yes`</span>,</span><br><span class="line">        options: &#123; ...options, <span class="attr">interceptors</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 和上一个相同</span></span><br><span class="line">request.interceptors.request.use(</span><br><span class="line">    (url, options) =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            url: <span class="string">`<span class="subst">$&#123;url&#125;</span>&amp;interceptors=yes`</span>,</span><br><span class="line">            options: &#123; ...options, <span class="attr">interceptors</span>: <span class="literal">true</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">global</span>: <span class="literal">true</span> &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// response拦截器, 处理response</span></span><br><span class="line">request.interceptors.response.use(<span class="function">(<span class="params">response, options</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> contentType = response.headers.get(<span class="string">'Content-Type'</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提前对响应做异常处理</span></span><br><span class="line">request.interceptors.response.use(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> codeMaps = &#123;</span><br><span class="line">        <span class="number">502</span>: <span class="string">'网关错误。'</span>,</span><br><span class="line">        <span class="number">503</span>: <span class="string">'服务不可用，服务器暂时过载或维护。'</span>,</span><br><span class="line">        <span class="number">504</span>: <span class="string">'网关超时。'</span></span><br><span class="line">    &#125;</span><br><span class="line">    message.error(codeMaps[response.status])</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 克隆响应对象做解析处理</span></span><br><span class="line">request.interceptors.response.use(<span class="keyword">async</span> response =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> response.clone().json()</span><br><span class="line">    <span class="keyword">if</span> (data &amp;&amp; data.NOT_LOGIN) &#123;</span><br><span class="line">        location.href = <span class="string">'登录url'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>实例内部拦截器</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局拦截器直接使用 request 实例中的方法</span></span><br><span class="line">request.interceptors.request.use(</span><br><span class="line">    (url, options) =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            url: <span class="string">`<span class="subst">$&#123;url&#125;</span>&amp;interceptors=yes`</span>,</span><br><span class="line">            options: &#123; ...options, <span class="attr">interceptors</span>: <span class="literal">true</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">global</span>: <span class="literal">false</span> &#125;</span><br><span class="line">) <span class="comment">// 第二个参数不传默认为 &#123; global: true &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createClient</span>(<span class="params">baseUrl</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> request = extend(&#123;</span><br><span class="line">        prefix: baseUrl</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> request</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clientA = createClient(<span class="string">'/api'</span>)</span><br><span class="line"><span class="keyword">const</span> clientB = createClient(<span class="string">'/api'</span>)</span><br><span class="line"><span class="comment">// 局部拦截器使用</span></span><br><span class="line">clientA.interceptors.request.use(</span><br><span class="line">    (url, options) =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            url: <span class="string">`<span class="subst">$&#123;url&#125;</span>&amp;interceptors=clientA`</span>,</span><br><span class="line">            options</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">global</span>: <span class="literal">false</span> &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">clientB.interceptors.request.use(</span><br><span class="line">    (url, options) =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            url: <span class="string">`<span class="subst">$&#123;url&#125;</span>&amp;interceptors=clientB`</span>,</span><br><span class="line">            options</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">global</span>: <span class="literal">false</span> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="取消请求"><a href="#取消请求" class="headerlink" title="取消请求"></a>取消请求</h2><p>你可以通过 <strong>cancel token</strong> 来取消一个请求</p>
<blockquote>
<p>cancel token API 是基于已被撤销的 <a href="https://github.com/tc39/proposal-cancelable-promises" target="_blank" rel="noopener">cancelable-promises 方案</a></p>
</blockquote>
<ol>
<li>你可以通过 <strong>CancelToken.source</strong> 来创建一个 cancel token，如下所示:</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Request <span class="keyword">from</span> <span class="string">'umi-request'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CancelToken = Request.CancelToken</span><br><span class="line"><span class="keyword">const</span> &#123; token, cancel &#125; = CancelToken.source()</span><br><span class="line"></span><br><span class="line">Request.get(<span class="string">'/api/cancel'</span>, &#123;</span><br><span class="line">    cancelToken: token</span><br><span class="line">&#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">thrown</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Request.isCancel(thrown)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Request canceled'</span>, thrown.message)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 处理异常</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">Request.post(</span><br><span class="line">    <span class="string">'/api/cancel'</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        name: <span class="string">'hello world'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        cancelToken: token</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取消请求(参数为非必填)</span></span><br><span class="line">cancel(<span class="string">'Operation canceled by the user.'</span>)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>你也可以通过实例化 CancelToken 来创建一个 token，同时通过传入函数来获取取消方法：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Request <span class="keyword">from</span> <span class="string">'umi-request'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CancelToken = Request.CancelToken</span><br><span class="line"><span class="keyword">let</span> cancel</span><br><span class="line"></span><br><span class="line">Request.get(<span class="string">'/api/cancel'</span>, &#123;</span><br><span class="line">    cancelToken: <span class="keyword">new</span> CancelToken(<span class="function"><span class="keyword">function</span> <span class="title">executor</span>(<span class="params">c</span>) </span>&#123;</span><br><span class="line">        cancel = c</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 取消请求</span></span><br><span class="line">cancel()</span><br></pre></td></tr></table></figure>

<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="如何获取响应头信息"><a href="#如何获取响应头信息" class="headerlink" title="如何获取响应头信息"></a>如何获取响应头信息</h3><p>通过 <strong>Headers.get()</strong> 获取响应头信息。(可参考 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Headers/get" target="_blank" rel="noopener">MDN 文档</a>)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request(<span class="string">'/api/v1/some/api'</span>, &#123; <span class="attr">getResponse</span>: <span class="literal">true</span> &#125;).then(</span><br><span class="line">    (&#123; data, response &#125;) =&gt; &#123;</span><br><span class="line">        response.headers.get(<span class="string">'Content-Type'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>使用 FormData() 构造函数时，浏览器会自动识别并添加请求头 <code>&quot;Content-Type: multipart/form-data&quot;</code>, 且参数依旧是表单提交时那种键值对，因此不需要开发者手动设置 <strong>Content-Type</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> formData = <span class="keyword">new</span> FormData()</span><br><span class="line">formData.append(<span class="string">'file'</span>, file)</span><br><span class="line">request(<span class="string">'/api/v1/some/api'</span>, &#123; <span class="attr">method</span>: <span class="string">'post'</span>, <span class="attr">data</span>: formData &#125;)</span><br></pre></td></tr></table></figure>

<p>如果希望获取自定义头部信息，需要在服务器设置 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Expose-Headers" target="_blank" rel="noopener">Access-Control-Expose-Headers</a>,然后可按照上述方式获取自定义头部信息。</p>
<h2 id="开发和调试"><a href="#开发和调试" class="headerlink" title="开发和调试"></a>开发和调试</h2><ul>
<li>npm install</li>
<li>npm run dev</li>
<li>npm link</li>
<li>然后到你测试的项目中执行 npm link umi-request</li>
<li>引入并使用</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swiftist.cn/2020/01/15/umi/umi-request-%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E4%B9%8B%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Andy Ge">
      <meta itemprop="description" content="勇于积极进取，步入人生的世外桃源">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="飞雪轩辕">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/15/umi/umi-request-%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E4%B9%8B%E8%B7%AF/" class="post-title-link" itemprop="url">umi-request 网络请求之路</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-15 08:13:05" itemprop="dateCreated datePublished" datetime="2020-01-15T08:13:05+08:00">2020-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-31 23:07:39" itemprop="dateModified" datetime="2020-03-31T23:07:39+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/umi/" itemprop="url" rel="index">
                    <span itemprop="name">umi</span>
                  </a>
                </span>
            </span>

          
            <span id="/2020/01/15/umi/umi-request-%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E4%B9%8B%E8%B7%AF/" class="post-meta-item leancloud_visitors" data-flag-title="umi-request 网络请求之路" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在做中台业务应用开发的过程中，我们发现在请求链路上存在以下问题：</p>
<ol>
<li><strong>请求库各式各样，没有统一。</strong> 每次新起应用都需要重复实现一套请求层逻辑，切换应用时需要重新学习请求库 API。</li>
<li><strong>各应用接口设计不一致、混乱。</strong> 前后端同学每次需重新设计接口格式，前端同学在切换应用时需重新了解接口格式才能做业务开发。</li>
<li><strong>接口文档维护各式各样。</strong> 有的在语雀（云端知识库）上，有的在 RAP （开源接口管理工具）上，有的靠阅读源码才能知道，无论是维护、mock 数据还是沟通都很浪费人力。</li>
</ol>
<p>针对以上问题，我们提出了<strong>请求层治理</strong>，希望能<strong>通过统一请求库、规范请求接口设计规范、统一接口文档</strong>这三步，对请求链路的前中后三个阶段进行<strong>提效和规范，</strong> 从而减少开发者在接口设计、文档维护、请求层逻辑开发上花费的沟通和人力成本。其中，<strong>统一请求库作为底层技术支持，需要提前打好基地，为上层提供稳定、完善的功能支持，基于此，umi-request 应运而生。</strong></p>
<h2 id="umi-request"><a href="#umi-request" class="headerlink" title="umi-request"></a>umi-request</h2><p><a href="https://link.zhihu.com/?target=https%3A//github.com/umijs/umi-request">umi-request</a> 是基于 fetch 封装的开源 http 请求库，旨在为开发者提供一个统一的 API 调用方式，同时简化使用方式，提供了请求层常用的功能：</p>
<ul>
<li>URL 参数自动序列化</li>
<li>POST 数据提交方式简化</li>
<li>Response 返回处理简化</li>
<li>请求超时处理</li>
<li>请求缓存支持</li>
<li>GBK 编码处理</li>
<li>统一的错误处理方式</li>
<li>请求取消支持</li>
<li>Node 环境 http 请求</li>
<li>拦截器机制</li>
<li>洋葱中间件机制</li>
</ul>
<h2 id="与-fetch、axios-的异同"><a href="#与-fetch、axios-的异同" class="headerlink" title="与 fetch、axios 的异同"></a>与 fetch、axios 的异同</h2><p><img src="/images/misc/v2-96ed949aa1475afeaf383668f2d41037_hd.jpg" alt=""></p>
<p>umi-request 底层抛弃了设计粗糙、不符合关注分离的 XMLHttpRequest，选择了更加语义化、基于标准 Promise 实现的 fetch（更多细节<a href="https://link.zhihu.com/?target=https%3A//github.com/camsong/blog/issues/2">详见</a>）；同时同构更方便，使用 <a href="https://link.zhihu.com/?target=https%3A//github.com/matthew-andrews/isomorphic-fetch">isomorphic-fetch</a>（目前已内置）；而基于各业务应用场景提取常见的请求能力并支持快速配置如 post 简化、前后缀、错误检查等。</p>
<h2 id="上手便捷"><a href="#上手便捷" class="headerlink" title="上手便捷"></a>上手便捷</h2><p>安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save umi-request</span><br></pre></td></tr></table></figure>

<p>执行 GET 请求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'umi-request'</span></span><br><span class="line">request</span><br><span class="line">    .get(<span class="string">'/api/v1/xxx?id=1'</span>)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="comment">// 也可将 URL 的参数放到 options.params 里</span></span><br><span class="line">request</span><br><span class="line">    .get(<span class="string">'/api/v1/xxx'</span>, &#123;</span><br><span class="line">        params: &#123;</span><br><span class="line">            id: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>执行 <strong>POST</strong> 请求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'umi-request'</span></span><br><span class="line">request</span><br><span class="line">    .post(<span class="string">'/api/v1/user'</span>, &#123;</span><br><span class="line">        data: &#123;</span><br><span class="line">            name: <span class="string">'Mike'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="实例化通用配置"><a href="#实例化通用配置" class="headerlink" title="实例化通用配置"></a>实例化通用配置</h2><p>请求一般都有一些通用的配置，我们不想在每个请求里去逐个添加，例如通用的前缀、后缀、头部信息、异常处理等等，那么可以通过 <strong>extend</strong> 来新建一个 umi-request 实例，从而减少重复的代码量：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; extend &#125; <span class="keyword">from</span> <span class="string">'umi-request'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> request = extend(&#123;</span><br><span class="line">    prefix: <span class="string">'/api/v1'</span>,</span><br><span class="line">    suffix: <span class="string">'.json'</span>,</span><br><span class="line">    timeout: <span class="number">1000</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'multipart/form-data'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    params: &#123;</span><br><span class="line">        token: <span class="string">'xxx'</span> <span class="comment">// 所有请求默认带上 token 参数</span></span><br><span class="line">    &#125;,</span><br><span class="line">    errorHandler: <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="comment">/* 异常处理 */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">request</span><br><span class="line">    .get(<span class="string">'/user'</span>)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="内置常见请求能力"><a href="#内置常见请求能力" class="headerlink" title="内置常见请求能力"></a>内置常见请求能力</h2><p>fetch 本身并不提供请求超时、缓存、取消等能力，而在业务开发中却常常需要，因此 umi-request 对常见的请求能力进行封装内置，减少重复开发：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 'params' 是即将于请求一起发送的 URL 参数，参数会自动 encode 后添加到 URL 中</span></span><br><span class="line">    <span class="comment">// 类型需为 Object 对象或者 URLSearchParams 对象</span></span><br><span class="line">    <span class="attr">"params"</span>: &#123; <span class="attr">"id"</span>: <span class="number">1</span> &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'paramsSerializer' 开发者可通过该函数对 params 做序列化（注意：此时传入的 params 为合并了 extends 中 params 参数的对象，如果传入的是 URLSearchParams 对象会转化为 Object 对象</span></span><br><span class="line">    <span class="attr">"paramsSerializer"</span>: function(params) &#123;</span><br><span class="line">        return Qs.stringify(params, &#123; "arrayFormat": "brackets" &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'data' 作为请求主体被发送的数据</span></span><br><span class="line">    <span class="comment">// 适用于这些请求方法 'PUT', 'POST', 和 'PATCH'</span></span><br><span class="line">    <span class="comment">// 必须是以下类型之一：</span></span><br><span class="line">    <span class="comment">// - string, plain object, ArrayBuffer, ArrayBufferView, URLSearchParams</span></span><br><span class="line">    <span class="comment">// - 浏览器专属：FormData, File, Blob</span></span><br><span class="line">    <span class="comment">// - Node 专属： Stream</span></span><br><span class="line">    "data": &#123; "name": "Mike" &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'headers' 请求头</span></span><br><span class="line">    "headers": &#123; "Content-Type": "multipart/form-data" &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'timeout' 指定请求超时的毫秒数（0 表示无超时时间）</span></span><br><span class="line">    <span class="comment">// 如果请求超过了 'timeout' 时间，请求将被中断并抛出请求异常</span></span><br><span class="line">    "timeout": 1000,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'prefix' 前缀，统一设置 url 前缀</span></span><br><span class="line">    <span class="comment">// ( e.g. request('/user/save', &#123; prefix: '/api/v1' &#125;) =&gt; request('/api/v1/user/save') )</span></span><br><span class="line">    "prefix": "",</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'suffix' 后缀，统一设置 url 后缀</span></span><br><span class="line">    <span class="comment">// ( e.g. request('/api/v1/user/save', &#123; suffix: '.json'&#125;) =&gt; request('/api/v1/user/save.json') )</span></span><br><span class="line">    "suffix": "",</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'credentials' 发送带凭据的请求</span></span><br><span class="line">    <span class="comment">// 为了让浏览器发送包含凭据的请求（即使是跨域源），需要设置 credentials: 'include'</span></span><br><span class="line">    <span class="comment">// 如果只想在请求URL与调用脚本位于同一起源处时发送凭据，请添加credentials: 'same-origin'</span></span><br><span class="line">    <span class="comment">// 要改为确保浏览器不在请求中包含凭据，请使用credentials: 'omit'</span></span><br><span class="line">    "credentials": "same-origin", // default</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'useCache' 是否使用缓存，当值为 true 时，GET 请求在 ttl 毫秒内将被缓存，缓存策略唯一 key 为 url + params 组合</span></span><br><span class="line">    "useCache": false, // default</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'ttl' 缓存时长（毫秒）， 0 为不过期</span></span><br><span class="line">    "ttl": 60000,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'maxCache' 最大缓存数， 0 为无限制</span></span><br><span class="line">    "maxCache": 0,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'charset' 当服务端返回的数据编码类型为 gbk 时可使用该参数，umi-request 会按 gbk 编码做解析，避免得到乱码, 默认为 utf8</span></span><br><span class="line">    <span class="comment">// 当 parseResponse 值为 false 时该参数无效</span></span><br><span class="line">    "charset": "gbk",</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'responseType': 如何解析返回的数据，当 parseResponse 值为 false 时该参数无效</span></span><br><span class="line">    <span class="comment">// 默认为 'json', 对返回结果进行 Response.text().then( d =&gt; JSON.parse(d) ) 解析</span></span><br><span class="line">    <span class="comment">// 其他(text, blob, arrayBuffer, formData), 做 Response[responseType]() 解析</span></span><br><span class="line">    "responseType": "json", // default</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'errorHandler' 统一的异常处理，供开发者对请求发生的异常做统一处理，详细使用请参考下方的错误处理文档</span></span><br><span class="line">    "errorHandler": function(error) &#123;</span><br><span class="line">        <span class="comment">/* 异常处理 */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="中间件机制方便拓展"><a href="#中间件机制方便拓展" class="headerlink" title="中间件机制方便拓展"></a>中间件机制方便拓展</h2><p>复杂场景应用对请求前后有定制化的处理需求，请求库除了提供基础的内置能力外，也需要提升自身拓展性，基于此 umi-request 引入<strong>中间件机制，</strong>选择了类 KOA 的洋葱圈模型：</p>
<p><img src="../../images/misc/v2-4ab4abbb796697cfd7dde516d3cdde08_hd.jpg" alt=""></p>
<p>（中间件洋葱图）</p>
<p>由上图可看出，每一层洋葱圈为一个中间件，请求经过一个中间件都会执行两次，开发者可以根据业务需求很方便地实现请求前后增强处理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'umi-request'</span></span><br><span class="line"></span><br><span class="line">request.use(<span class="function"><span class="keyword">function</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'a1'</span>)</span><br><span class="line">    <span class="keyword">return</span> next().then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'a2'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">request.use(<span class="function"><span class="keyword">function</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'b1'</span>)</span><br><span class="line">    <span class="keyword">return</span> next().then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'b2'</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 执行顺序如下：</span></span><br><span class="line"><span class="comment">// a1 -&gt; b1 -&gt; b2 -&gt; a2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 async/await 能让结构、顺序更清晰明了：</span></span><br><span class="line">request.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'a1'</span>)</span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'a2'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">request.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'b1'</span>)</span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'b2'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> request(<span class="string">'/api/v1/a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行顺序如下：</span></span><br><span class="line"><span class="comment">// a1 -&gt; b1 -&gt; b2 -&gt; a2</span></span><br></pre></td></tr></table></figure>

<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>那么洋葱圈的中间件机制是如何实现的呢？它主要由中间件数组和中间件组合两部分组成，前者负责存储挂载的中间件，后者负责将中间件按照洋葱的结构进行组合并返回真实可执行函数：</p>
<h3 id="存储中间件"><a href="#存储中间件" class="headerlink" title="存储中间件"></a>存储中间件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Onion</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>.middlewares = []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 存储中间件</span></span><br><span class="line">    use(newMiddleware) &#123;</span><br><span class="line">        <span class="keyword">this</span>.middlewares.push(newMiddleware)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行中间件</span></span><br><span class="line">    execute(params = <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> fn = compose(<span class="keyword">this</span>.middlewares)</span><br><span class="line">        <span class="keyword">return</span> fn(params)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="组合中间件"><a href="#组合中间件" class="headerlink" title="组合中间件"></a>组合中间件</h3><p>上述代码中的 <strong>compose</strong> 即为组合中间件的函数实现，精简后逻辑如下（<a href="https://link.zhihu.com/?target=https%3A//github.com/umijs/umi-request/blob/master/src/onion/compose.js">详见</a>）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">middlewares</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapMiddlewares</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> index = <span class="number">-1</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">            index = i</span><br><span class="line">            <span class="keyword">const</span> fn = middlewares[i]</span><br><span class="line">            <span class="keyword">if</span> (!fn) <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(fn(params, () =&gt; dispatch(i + <span class="number">1</span>)))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dispatch(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>compose 函数通过 <strong>dispatch(0)</strong> 先执行了第一个中间件 <code>fn(params, () =&gt; dispatch(i +1))</code> ,并提供 <code>() =&gt; dispatch(i +1)</code> 作为入参供每个中间件能在下一个中间件执行完毕后回来继续处理自己的事务，直到所有中间件完成后执行 <code>Promise.resolve()</code> ，形成洋葱圈中间件机制。</p>
<h2 id="丰富请求能力"><a href="#丰富请求能力" class="headerlink" title="丰富请求能力"></a>丰富请求能力</h2><p>面对多端、多设备应用，umi-request 不仅支持 browser http 请求，也同时满足 node 环境、自定义内核请求等能力。</p>
<h3 id="支持-node-环境发送-http-请求"><a href="#支持-node-环境发送-http-请求" class="headerlink" title="支持 node 环境发送 http 请求"></a>支持 node 环境发送 http 请求</h3><p>基于 isomorphic-fetch 实现对 node 环境的请求支持：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> umi = <span class="built_in">require</span>(<span class="string">'umi-request'</span>)</span><br><span class="line"><span class="keyword">const</span> extendRequest = umi.extend(&#123; <span class="attr">timeout</span>: <span class="number">10000</span> &#125;)</span><br><span class="line"></span><br><span class="line">extendRequest(<span class="string">'/api/user'</span>)</span><br><span class="line">    .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res)</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="支持自定义内核请求能力"><a href="#支持自定义内核请求能力" class="headerlink" title="支持自定义内核请求能力"></a>支持自定义内核请求能力</h3><p>移动端应用一般都会有自己的请求协议如 RPC 请求，前端会通过 SDK 去调用客户端请求 API，umi-request 支持开发者自己封装请求能力，例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// service/some.js</span></span><br><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'umi-request'</span></span><br><span class="line"><span class="comment">// 自定义请求内核中间件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SDKRequest</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; req &#125; = ctx</span><br><span class="line">    <span class="keyword">const</span> &#123; url, options &#125; = req</span><br><span class="line">    <span class="keyword">const</span> &#123; __umiRequestCoreType__ = <span class="string">'normal'</span> &#125; = options</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__umiRequestCoreType__.toLowerCase() !== <span class="string">'SDKRequest'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> next()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</span><br><span class="line">        .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> SDK.request(url, options) <span class="comment">// 假设已经引入了 SDK 并且能通过 SDK 发起对应请求</span></span><br><span class="line">        &#125;)</span><br><span class="line">        .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">            ctx.res = result <span class="comment">// 将结果注入到 ctx 的 res 里</span></span><br><span class="line">            <span class="keyword">return</span> next()</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">request.use(SDKRequest, &#123; <span class="attr">core</span>: <span class="literal">true</span> &#125;) <span class="comment">// 引入内核中间件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">queryUser</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> request(<span class="string">'/api/sdk/request'</span>, &#123;</span><br><span class="line">        __umiRequestCoreType__: <span class="string">'SDKRequest'</span>, <span class="comment">// 声明使用 SDKRequest 来发起请求</span></span><br><span class="line">        data: []</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>随着 umi-request 能力的完善，已经能够支持各个场景、端应用的请求，前端开发只需要掌握一套 API 调用就能实现多端开发，再也不用关注底层协议实现，把更多的精力放在前端开发上。而基于此，umi-request 能在底层做更多的事情，如 mock 数据、自动识别请求类型、接口异常监控上报、接口规范校验等等，最终实现请求治理的目标。umi-request 还有很多能力没有在文中提及，如有兴趣欢迎查看<a href="https://link.zhihu.com/?target=https%3A//github.com/umijs/umi-request/blob/master/README_zh-CN.md">详细文档</a>，如果你有好的建议和需求，也欢迎提 <a href="https://link.zhihu.com/?target=https%3A//github.com/umijs/umi/issues">issue</a>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swiftist.cn/2020/01/15/vscode/VsCode%E6%90%AD%E5%BB%BAJava%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%EF%BC%88Spring-Boot%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA%E3%80%81%E8%BF%90%E8%A1%8C%E3%80%81%E8%B0%83%E8%AF%95%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Andy Ge">
      <meta itemprop="description" content="勇于积极进取，步入人生的世外桃源">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="飞雪轩辕">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/15/vscode/VsCode%E6%90%AD%E5%BB%BAJava%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%EF%BC%88Spring-Boot%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA%E3%80%81%E8%BF%90%E8%A1%8C%E3%80%81%E8%B0%83%E8%AF%95%EF%BC%89/" class="post-title-link" itemprop="url">VsCode搭建Java开发环境（Spring Boot项目创建、运行、调试）</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-15 06:54:55" itemprop="dateCreated datePublished" datetime="2020-01-15T06:54:55+08:00">2020-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-31 23:07:39" itemprop="dateModified" datetime="2020-03-31T23:07:39+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/vscode/" itemprop="url" rel="index">
                    <span itemprop="name">vscode</span>
                  </a>
                </span>
            </span>

          
            <span id="/2020/01/15/vscode/VsCode%E6%90%AD%E5%BB%BAJava%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%EF%BC%88Spring-Boot%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA%E3%80%81%E8%BF%90%E8%A1%8C%E3%80%81%E8%B0%83%E8%AF%95%EF%BC%89/" class="post-meta-item leancloud_visitors" data-flag-title="VsCode搭建Java开发环境（Spring Boot项目创建、运行、调试）" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="安装扩展"><a href="#安装扩展" class="headerlink" title="安装扩展"></a>安装扩展</h2><p>安装如下两个主要扩展即可，这两个扩展已关联 java 项目开发主要使用的 maven、springboot 等所需要的扩展。</p>
<p><img src="/images/vscode/949088-20181018140701454-853945200.png" alt=""></p>
<p>开始步骤：</p>
<ol>
<li>在 Visual Studio Code 中打开扩展视图(Ctrl+Shift+X)。</li>
<li>输入“java”搜索商店扩展插件。</li>
<li>找到并安装 <a href="https://marketplace.visualstudio.com/items?itemName=vscjava.vscode-java-pack" target="_blank" rel="noopener">Java Extension Pack (Java 扩展包)</a>，如果你已经安装了 <a href="https://marketplace.visualstudio.com/items?itemName=redhat.java" target="_blank" rel="noopener">Language Support for Java(TM) by Red Hat</a>，也可以单独找到并安装 <a href="https://marketplace.visualstudio.com/items?itemName=vscjava.vscode-java-debug" target="_blank" rel="noopener">Java Debugger for Visual Studio Code</a> 扩展。</li>
<li>输入“Spring Boot Extension”搜索商店扩展插件。</li>
<li>找到并安装 “Spring Boot Extension Pack”。安装过程中可能会比较慢，耐心等待即可。</li>
</ol>
<p>配置 Maven：</p>
<p>点左下角的设置图标-&gt;设置，打开设置内容筛选框，输入 maven，然后点击右侧的打开 json 格式 setting：</p>
<p><img src="../../images/vscode/949088-20181018142037876-936312706.png" alt=""></p>
<p>然后把 maven 的可执行文件路径配置、maven 的 setting 路径配置、java.home 的路径配置，拷贝到右侧的用户设置区域并且设置为自己电脑的实际路径</p>
<p><img src="../../images/vscode/949088-20181018142807301-1282887727.png" alt=""></p>
<p>设置内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"workbench.iconTheme"</span>: <span class="string">"vscode-icons"</span>,</span><br><span class="line">    <span class="attr">"workbench.startupEditor"</span>: <span class="string">"newUntitledFile"</span>,</span><br><span class="line">    <span class="attr">"java.errors.incompleteClasspath.severity"</span>: <span class="string">"ignore"</span>,</span><br><span class="line">    <span class="attr">"workbench.colorTheme"</span>: <span class="string">"Atom One Dark"</span>,</span><br><span class="line">    <span class="attr">"java.home"</span>: <span class="string">"D:\\software\\Java\\jdk1.8.0_60"</span>,</span><br><span class="line">    <span class="attr">"java.configuration.maven.userSettings"</span>: <span class="string">"D:\\software\\apache-maven-3.3.3-bin\\apache-maven-3.3.3\\conf\\settings.xml"</span>,</span><br><span class="line">    <span class="attr">"maven.executable.path"</span>: <span class="string">"D:\\software\\apache-maven-3.3.3-bin\\apache-maven-3.3.3\\bin\\mvn.cmd"</span>,</span><br><span class="line">    <span class="attr">"maven.terminal.useJavaHome"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"maven.terminal.customEnv"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"environmentVariable"</span>: <span class="string">"JAVA_HOME"</span>,</span><br><span class="line">            <span class="attr">"value"</span>: <span class="string">"D:\\software\\Java\\jdk1.8.0_60"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你的 mvn 更新包速度很慢，建议使用阿里云的镜像速度会快点（修改 maven 的 setting 配置如下）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 阿里云仓库 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/repositories/central/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 中央仓库1 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>repo1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo1.maven.org/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 中央仓库2 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>repo2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo2.maven.org/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置完成重启 VSCode。</p>
<h2 id="创建-Spring-Boot-项目"><a href="#创建-Spring-Boot-项目" class="headerlink" title="创建 Spring Boot 项目"></a>创建 Spring Boot 项目</h2><p>使用快捷键(Ctrl+Shift+P)命令窗口，输入 Spring 选择创建 Maven 项目。 效果如下：</p>
<p><img src="../../images/vscode/949088-20181019110527579-986789609.png" alt=""></p>
<p>选择需要使用的语言、Group Id、项目名称等，这里选择 Java：</p>
<p><img src="../../images/vscode/949088-20181019110754155-40455743.png" alt=""></p>
<p><img src="../../images/vscode/949088-20181019110856222-1209305730.png" alt=""></p>
<p><img src="../../images/vscode/949088-20181019111002777-1987557021.png" alt=""></p>
<p>选择 Spring Boot 版本：</p>
<p><img src="../../images/vscode/949088-20181019111039119-440533955.png" alt=""></p>
<p>选择需要引入的包，引入如下几个包即可满足 web 开发：</p>
<p>DevTools（代码修改热更新，无需重启）、Web（集成 tomcat、SpringMVC）、Lombok（智能生成 setter、getter、toString 等接口，无需手动生成，代码更简介）、Thymeleaf （模板引擎）。</p>
<p>选择好要引入的包后直接回车，在新弹出的窗口中选择项目路径，至此 Spring Boot 项目创建完成。</p>
<p><img src="../../images/vscode/949088-20181019111826340-254130709.png" alt=""></p>
<p>创建好后 vscode 右下角会有如下提示，点击 Open it 即可打开刚才创建的 Spring Boot 项目。</p>
<p><img src="../../images/vscode/949088-20181019112116653-410014195.png" alt=""></p>
<h2 id="项目运行跟调试"><a href="#项目运行跟调试" class="headerlink" title="项目运行跟调试"></a>项目运行跟调试</h2><p>项目创建后会自动创建 DemoApplication.java 文件，在 DemoApplication 文件目录下新建文件夹 Controller，新建文件 HomeController.java。效果如下：</p>
<p><img src="../../images/vscode/949088-20181019133810848-1910514658.png" alt=""></p>
<blockquote>
<p>SpringBoot 项目的 Bean 装配默认规则是根据 DemoApplication 类所在的包位置从上往下扫描。所以必须放在同一目录下否则会无法访问报如下所示错误：</p>
</blockquote>
<p><img src="../../images/vscode/949088-20181018171327250-1855055392.png" alt=""></p>
<p>启动工程之前还需要配置下运行环境，如下图，点左边的小虫子图标，然后点上面的下拉箭头，选择添加配置，第一次设置时 VS Code 会提示选择需要运行的语言环境，选择对应环境后自动创建 launch.json 文件。</p>
<p><img src="../../images/vscode/949088-20181018170430790-1469607250.png" alt=""></p>
<p>launch.json 调试配置文件如下，默认不修改配置也可使用：</p>
<p><img src="../../images/vscode/949088-20181018170816359-2101824580.png" alt=""></p>
<p>选择对应的配置环境调式项目如下，默认端口为 8080。</p>
<p><img src="../../images/vscode/949088-20181018170940292-676370504.png" alt=""></p>
<p>启动后可在控制台输出面板查看启动信息，显示如下后，访问：<a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a>即可。</p>
<p><img src="../../images/vscode/949088-20181018171203180-856160012.png" alt=""></p>
<p>最终效果如下：</p>
<p><img src="../../images/vscode/949088-20181019135017904-1365099465.png" alt=""></p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p>2.16 版本官方推荐的项目结构如下：</p>
<p><img src="../../images/vscode/1508611-20190626193341571-2039719902.png" alt=""></p>
<p>目前用得更多的是类似这种结构：</p>
<p><img src="../../images/vscode/1508611-20190626193402767-1336141304.png" alt=""></p>
<p>保存后 VS Code 自动下载该模块，也可以右键 pom.xml，点击 Update project configuration 手动更新配置</p>
<p><img src="../../images/vscode/1508611-20190626193508197-823646822.png" alt=""></p>
<p>pom.xml 文件中默认有两个模块：</p>
<p>spring-boot-starter ：核心模块，包括自动配置支持、日志和 YAML，如果引入了 spring-boot-starter-web web 模块可以去掉此配置，因为 spring-boot-starter-web 自动依赖了 spring-boot-starter。</p>
<p>spring-boot-starter-test ：测试模块，包括 JUnit、Hamcrest、Mockito。</p>
<h2 id="访问-HTML-页面"><a href="#访问-HTML-页面" class="headerlink" title="访问 HTML 页面"></a>访问 HTML 页面</h2><p>在 spring boot 中访问 html 需要引入 Thymeleaf （模板引擎）包，在创建项目时已引用该包这里不需在重复引用。在 resources–&gt;templates 目录下创建 Index.html 文件，效果如下：</p>
<p><img src="../../images/vscode/949088-20181019135536794-1609170362.png" alt=""></p>
<p>html 内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>第一个HTML页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello Spring Boot!!!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:text</span>=<span class="string">"$&#123;hello&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 controller 目录下新建 TestController.java 文件，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controllerpublic</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本地访问内容地址 ：http://localhost:8080/hello</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span>    <span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">helloHtml</span><span class="params">(HashMap&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class="line">        map.put(<span class="string">"hello"</span>, <span class="string">"欢迎进入HTML页面"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/index"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果要访问 html 页面注解必须为 Controller 不能为 RestController。否则无法访问。</p>
</blockquote>
<p><strong>RestController 和 Controller 的区别：</strong></p>
<p>@RestController is a stereotype annotation that combines @ResponseBody and @Controller.<br>意思是：<br>@RestController 注解相当于@ResponseBody ＋ @Controller 合在一起的作用。<br>1)如果只是使用@RestController 注解 Controller，则 Controller 中的方法无法返回 jsp 页面，配置的视图解析器 InternalResourceViewResolver 不起作用，返回的内容就是 Return 里的内容。</p>
<p>例如：本来应该到 success.html 页面的，则其显示 success.</p>
<p>2)如果需要返回到指定页面，则需要用 @Controller 配合视图解析器 InternalResourceViewResolver 才行。</p>
<p>3)如果需要返回 json 或者 xml 或者自定义 mediaType 内容到页面，则需要在对应的方法上加上@ResponseBody 注解</p>
<p>效果展示如下：</p>
<p><img src="../../images/vscode/949088-20181019140657585-1350811104.png" alt=""></p>
<p>到处基础配置结束，可以愉快的玩耍 Spring Boot!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swiftist.cn/2020/01/14/mvn/%E9%98%BF%E9%87%8Cmaven%E9%95%9C%E5%83%8F%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Andy Ge">
      <meta itemprop="description" content="勇于积极进取，步入人生的世外桃源">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="飞雪轩辕">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/14/mvn/%E9%98%BF%E9%87%8Cmaven%E9%95%9C%E5%83%8F%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">阿里maven镜像配置</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-14 09:24:10" itemprop="dateCreated datePublished" datetime="2020-01-14T09:24:10+08:00">2020-01-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-31 23:07:39" itemprop="dateModified" datetime="2020-03-31T23:07:39+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mvn/" itemprop="url" rel="index">
                    <span itemprop="name">mvn</span>
                  </a>
                </span>
            </span>

          
            <span id="/2020/01/14/mvn/%E9%98%BF%E9%87%8Cmaven%E9%95%9C%E5%83%8F%E9%85%8D%E7%BD%AE/" class="post-meta-item leancloud_visitors" data-flag-title="阿里maven镜像配置" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>setting.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!-- 阿里云仓库 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/repositories/central/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 中央仓库1 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>repo1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo1.maven.org/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 中央仓库2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>repo2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Human Readable Name for this Mirror.<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo2.maven.org/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swiftist.cn/2020/01/14/mvn/%E6%9B%B4%E6%94%B9maven%E4%BB%93%E5%BA%93%E6%BA%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Andy Ge">
      <meta itemprop="description" content="勇于积极进取，步入人生的世外桃源">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="飞雪轩辕">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/14/mvn/%E6%9B%B4%E6%94%B9maven%E4%BB%93%E5%BA%93%E6%BA%90/" class="post-title-link" itemprop="url">更改maven仓库源</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-14 05:45:13" itemprop="dateCreated datePublished" datetime="2020-01-14T05:45:13+08:00">2020-01-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-31 23:07:39" itemprop="dateModified" datetime="2020-03-31T23:07:39+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mvn/" itemprop="url" rel="index">
                    <span itemprop="name">mvn</span>
                  </a>
                </span>
            </span>

          
            <span id="/2020/01/14/mvn/%E6%9B%B4%E6%94%B9maven%E4%BB%93%E5%BA%93%E6%BA%90/" class="post-meta-item leancloud_visitors" data-flag-title="更改maven仓库源" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h1><h2 id="查找目录"><a href="#查找目录" class="headerlink" title="查找目录"></a>查找目录</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示maven版本，其中可以看到maven本地文件夹地址</span></span><br><span class="line">mvn -v</span><br><span class="line"></span><br><span class="line">Apache Maven 3.5.3 (3383c37e1f9e9b3bc3df5050c29c8aff9f295297; 2018-02-25T03:49:05+08:00)</span><br><span class="line">Maven home: /Library/apache-maven-3.5.3</span><br><span class="line">Java version: 1.8.0_121, vendor: Oracle Corporation</span><br><span class="line">Java home: /Library/Java/JavaVirtualMachines/jdk1.8.0_121.jdk/Contents/Home/jre</span><br><span class="line">Default locale: zh_CN, platform encoding: UTF-8</span><br><span class="line">OS name: <span class="string">"mac os x"</span>, version: <span class="string">"10.15.2"</span>, arch: <span class="string">"x86_64"</span>, family: <span class="string">"mac"</span></span><br></pre></td></tr></table></figure>

<h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改配置</span></span><br><span class="line">vim /Library/apache-maven-3.5.3/conf/settings.xml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>settings.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swiftist.cn/2020/01/13/linux/Firewalld/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Andy Ge">
      <meta itemprop="description" content="勇于积极进取，步入人生的世外桃源">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="飞雪轩辕">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/13/linux/Firewalld/" class="post-title-link" itemprop="url">Firewalld</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-13 16:07:43" itemprop="dateCreated datePublished" datetime="2020-01-13T16:07:43+08:00">2020-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-31 23:07:39" itemprop="dateModified" datetime="2020-03-31T23:07:39+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>
            </span>

          
            <span id="/2020/01/13/linux/Firewalld/" class="post-meta-item leancloud_visitors" data-flag-title="Firewalld" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h1><h2 id="一、系统环境"><a href="#一、系统环境" class="headerlink" title="一、系统环境"></a>一、系统环境</h2><p>Centos7</p>
<h2 id="二、安装"><a href="#二、安装" class="headerlink" title="二、安装"></a>二、安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y firewalld</span><br></pre></td></tr></table></figure>

<h2 id="三、-基本启动命令"><a href="#三、-基本启动命令" class="headerlink" title="三、 基本启动命令"></a>三、 基本启动命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl status firewalld                <span class="comment"># 查看状态</span></span><br><span class="line">systemctl start firewalld                  <span class="comment"># 启动</span></span><br><span class="line">systemctl stop firewalld                  <span class="comment">#关闭</span></span><br><span class="line">systemctl <span class="built_in">enable</span> firewalld              <span class="comment"># 开机启动</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld             <span class="comment"># 取消开机启动</span></span><br></pre></td></tr></table></figure>

<h2 id="四、常用命令"><a href="#四、常用命令" class="headerlink" title="四、常用命令"></a>四、常用命令</h2><h3 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --get-active-zones   <span class="comment"># 查看激活的域</span></span><br><span class="line">firewall-cmd --zone=public --list-ports  <span class="comment"># 查看开放的端口</span></span><br><span class="line">firewall-cmd --zone=public --list-rich-rules  <span class="comment"># 查看添加的规则</span></span><br></pre></td></tr></table></figure>

<h3 id="添加端口"><a href="#添加端口" class="headerlink" title="添加端口"></a>添加端口</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开放单个端口</span></span><br><span class="line">firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开放端口范围</span></span><br><span class="line">firewall-cmd --zone=public --add-port=8388-8389/tcp --permanent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对 147.152.139.197 开放10000端口</span></span><br><span class="line">firewall-cmd --permanent --zone=public --add-rich-rule=<span class="string">'</span></span><br><span class="line"><span class="string">        rule family="ipv4"</span></span><br><span class="line"><span class="string">        source address="147.152.139.197/32"</span></span><br><span class="line"><span class="string">        port protocol="tcp" port="10000" accept'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拒绝端口：</span></span><br><span class="line">firewall-cmd --permanent --zone=public --add-rich-rule=<span class="string">'</span></span><br><span class="line"><span class="string">              rule family="ipv4"</span></span><br><span class="line"><span class="string">              source address="47.52.39.197/32"</span></span><br><span class="line"><span class="string">              port protocol="tcp" port="10000" reject'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开放全部端口给IP</span></span><br><span class="line">firewall-cmd --permanent --zone=public --add-rich-rule=<span class="string">'</span></span><br><span class="line"><span class="string">              rule family="ipv4"</span></span><br><span class="line"><span class="string">              source address="192.168.0.1/32" accept'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开放全部端口给网段</span></span><br><span class="line">firewall-cmd --permanent --zone=public --add-rich-rule=<span class="string">'</span></span><br><span class="line"><span class="string">              rule family="ipv4"</span></span><br><span class="line"><span class="string">              source address="192.168.0.0/16" accept'</span>;</span><br></pre></td></tr></table></figure>

<h3 id="添加服务"><a href="#添加服务" class="headerlink" title="添加服务"></a>添加服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看全部支持的服务</span></span><br><span class="line">firewall-cmd --get-service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看开放的服务</span></span><br><span class="line">firewall-cmd --list-service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加服务,添加https</span></span><br><span class="line">firewall-cmd --add-service=https --permanent</span><br></pre></td></tr></table></figure>

<p>修改对应的配置文件是<code>/etc/firewalld/zones/public.xml</code></p>
<h3 id="移除端口"><a href="#移除端口" class="headerlink" title="移除端口"></a>移除端口</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 移除添加的端口</span></span><br><span class="line">firewall-cmd --zone=public --remove-port=80/tcp --permanent</span><br></pre></td></tr></table></figure>

<h3 id="重载配置"><a href="#重载配置" class="headerlink" title="重载配置"></a>重载配置</h3><p>对路由规则进行修改后，需要重新加载规则才能使规则生效</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swiftist.cn/2020/01/13/linux/Linux-Firewalld%E7%94%A8%E6%B3%95%E5%8F%8A%E6%A1%88%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Andy Ge">
      <meta itemprop="description" content="勇于积极进取，步入人生的世外桃源">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="飞雪轩辕">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/13/linux/Linux-Firewalld%E7%94%A8%E6%B3%95%E5%8F%8A%E6%A1%88%E4%BE%8B/" class="post-title-link" itemprop="url">Linux Firewalld用法及案例</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-13 15:57:04" itemprop="dateCreated datePublished" datetime="2020-01-13T15:57:04+08:00">2020-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-31 23:07:39" itemprop="dateModified" datetime="2020-03-31T23:07:39+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>
            </span>

          
            <span id="/2020/01/13/linux/Linux-Firewalld%E7%94%A8%E6%B3%95%E5%8F%8A%E6%A1%88%E4%BE%8B/" class="post-meta-item leancloud_visitors" data-flag-title="Linux Firewalld用法及案例" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h1><ul>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/sec-using_firewalls" target="_blank" rel="noopener">RHEL</a></li>
<li><a href="http://www.firewalld.org/documentation/" target="_blank" rel="noopener">FIREWALLD</a></li>
</ul>
<h1 id="Firewalld-概述"><a href="#Firewalld-概述" class="headerlink" title="Firewalld 概述"></a>Firewalld 概述</h1><ul>
<li>动态防火墙管理工具</li>
<li>定义区域与接口安全等级</li>
<li>运行时和永久配置项分离</li>
<li>两层结构<ul>
<li>核心层 处理配置和后端，如 iptables、ip6tables、ebtables、ipset 和模块加载器</li>
<li>顶层 D-Bus 更改和创建防火墙配置的主要方式。所有 firewalld 都使用该接口提供在线工具</li>
</ul>
</li>
</ul>
<h1 id="原理图"><a href="#原理图" class="headerlink" title="原理图"></a>原理图</h1><p><img src="/images/linux/20180502182244373.png" alt="这里写图片描述"><br><img src="../../images/linux/20180502182231252.png" alt="这里写图片描述"></p>
<h1 id="Firewalld-与-iptables-对比"><a href="#Firewalld-与-iptables-对比" class="headerlink" title="Firewalld 与 iptables 对比"></a>Firewalld 与 iptables 对比</h1><ul>
<li>firewalld 是 iptables 的前端控制器</li>
<li>iptables 静态防火墙 任一策略变更需要 reload 所有策略，丢失现有链接</li>
<li>firewalld 动态防火墙 任一策略变更不需要 reload 所有策略 将变更部分保存到 iptables,不丢失现有链接</li>
<li>firewalld 提供一个 daemon 和 service 底层使用 iptables</li>
<li>基于内核的 Netfilter</li>
</ul>
<h1 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h1><ul>
<li>firewall-config 图形界面</li>
<li>firewall-cmd 命令行工具</li>
<li>直接修改配置文件<ul>
<li>/lib/firewalld 用于默认和备用配置</li>
<li>/etc/firewalld 用于用户创建和自定义配置文件 覆盖默认配置</li>
<li>/etc/firewalld/firewall.conf 全局配置</li>
</ul>
</li>
</ul>
<h1 id="运行时配置和永久配置"><a href="#运行时配置和永久配置" class="headerlink" title="运行时配置和永久配置"></a>运行时配置和永久配置</h1><ul>
<li>firewall-cmd –zone=public –add-service=smtp 运行时配置，重启后失效</li>
<li>firewall-cmd –permanent –zone=public –add-service=smtp 永久配置，不影响当前连接，重启后生效</li>
<li>firewall-cmd –runtime-to-permanent 将运行时配置保存为永久配置</li>
</ul>
<h1 id="Zone"><a href="#Zone" class="headerlink" title="Zone"></a>Zone</h1><ul>
<li>网络连接的可信等级,一对多，一个区域对应多个连接</li>
<li>drop.xml 拒绝所有的连接</li>
<li>block.xml 拒绝所有的连接</li>
<li>public.xml 只允许指定的连接 *默认区域</li>
<li>external.xml 只允许指定的连接</li>
<li>dmz.xml 只允许指定的连接</li>
<li>work.xml 只允许指定的连接</li>
<li>home.xml 只允许指定的连接</li>
<li>internal.xml 只允许指定的连接</li>
<li>trusted.xml 允许所有的连接<ul>
<li>/lib/firewalld/zones 默认和备用区域配置</li>
<li>/etc/firewalld/zones 用户创建和自定义区域配置文件 覆盖默认配置</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">zone</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">short</span>&gt;</span>Public<span class="tag">&lt;/<span class="name">short</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>For use in public areas. You do not trust the other computers on networks to not harm yo</span><br><span class="line">ur computer. Only selected incoming connections are accepted.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"ssh"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"dhcpv6-client"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">zone</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">version=<span class="string">"string"</span> 版本</span><br><span class="line">target=<span class="string">"ACCEPT|%%REJECT%%|DROP"</span> 默认REJECT 策略</span><br><span class="line">short 名称</span><br><span class="line">description 描述</span><br><span class="line">interface 接口</span><br><span class="line">    name=<span class="string">"string"</span></span><br><span class="line"><span class="built_in">source</span> 源地址</span><br><span class="line">    address=<span class="string">"address[/mask]"</span></span><br><span class="line">    mac=<span class="string">"MAC"</span></span><br><span class="line">    ipset=<span class="string">"ipset"</span></span><br><span class="line">service 服务</span><br><span class="line">    name=<span class="string">"string"</span></span><br><span class="line">port 端口</span><br><span class="line">    port=<span class="string">"portid[-portid]"</span></span><br><span class="line">    protocol=<span class="string">"tcp|udp"</span></span><br><span class="line">protocol 协议</span><br><span class="line">    value=<span class="string">"string"</span></span><br><span class="line">icmp-block</span><br><span class="line">    name=<span class="string">"string"</span></span><br><span class="line">icmp-block-inversion</span><br><span class="line">masquerade</span><br><span class="line">forward-port</span><br><span class="line">    port=<span class="string">"portid[-portid]"</span></span><br><span class="line">    protocol=<span class="string">"tcp|udp"</span></span><br><span class="line">    to-port=<span class="string">"portid[-portid]"</span></span><br><span class="line">    to-addr=<span class="string">"address"</span></span><br><span class="line"><span class="built_in">source</span>-port</span><br><span class="line">    port=<span class="string">"portid[-portid]"</span></span><br><span class="line">    protocol=<span class="string">"tcp|udp"</span></span><br><span class="line">rule</span><br><span class="line">&lt;rule [family=<span class="string">"ipv4|ipv6"</span>]&gt;</span><br><span class="line">  [ &lt;<span class="built_in">source</span> address=<span class="string">"address[/mask]"</span> [invert=<span class="string">"True"</span>]/&gt; ]</span><br><span class="line">  [ &lt;destination address=<span class="string">"address[/mask]"</span> [invert=<span class="string">"True"</span>]/&gt; ]</span><br><span class="line">  [</span><br><span class="line">    &lt;service name=<span class="string">"string"</span>/&gt; |</span><br><span class="line">    &lt;port port=<span class="string">"portid[-portid]"</span> protocol=<span class="string">"tcp|udp"</span>/&gt; |</span><br><span class="line">    &lt;protocol value=<span class="string">"protocol"</span>/&gt; |</span><br><span class="line">    &lt;icmp-block name=<span class="string">"icmptype"</span>/&gt; |</span><br><span class="line">    &lt;masquerade/&gt; |</span><br><span class="line">    &lt;forward-port port=<span class="string">"portid[-portid]"</span> protocol=<span class="string">"tcp|udp"</span> [to-port=<span class="string">"portid[-portid]"</span>] [to-addr=<span class="string">"address"</span>]/&gt; |</span><br><span class="line">    &lt;<span class="built_in">source</span>-port port=<span class="string">"portid[-portid]"</span> protocol=<span class="string">"tcp|udp"</span>/&gt; |</span><br><span class="line">  ]</span><br><span class="line">  [ &lt;<span class="built_in">log</span> [prefix=<span class="string">"prefixtext"</span>] [level=<span class="string">"emerg|alert|crit|err|warn|notice|info|debug"</span>]/&gt; [&lt;<span class="built_in">limit</span> value=<span class="string">"rate/duration"</span>/&gt;] &lt;/<span class="built_in">log</span>&gt; ]</span><br><span class="line">  [ &lt;audit&gt; [&lt;<span class="built_in">limit</span> value=<span class="string">"rate/duration"</span>/&gt;] &lt;/audit&gt; ]</span><br><span class="line">  [</span><br><span class="line">    &lt;accept&gt; [&lt;<span class="built_in">limit</span> value=<span class="string">"rate/duration"</span>/&gt;] &lt;/accept&gt; |</span><br><span class="line">    &lt;reject [<span class="built_in">type</span>=<span class="string">"rejecttype"</span>]&gt; [&lt;<span class="built_in">limit</span> value=<span class="string">"rate/duration"</span>/&gt;] &lt;/reject&gt; |</span><br><span class="line">    &lt;drop&gt; [&lt;<span class="built_in">limit</span> value=<span class="string">"rate/duration"</span>/&gt;] &lt;/drop&gt; |</span><br><span class="line">    &lt;mark <span class="built_in">set</span>=<span class="string">"mark[/mask]"</span>&gt; [&lt;<span class="built_in">limit</span> value=<span class="string">"rate/duration"</span>/&gt;] &lt;/mark&gt;</span><br><span class="line">  ]</span><br><span class="line">&lt;/rule&gt;</span><br><span class="line"></span><br><span class="line">rich rule</span><br><span class="line">&lt;rule [family=<span class="string">"ipv4|ipv6"</span>]&gt;</span><br><span class="line">  &lt;<span class="built_in">source</span> address=<span class="string">"address[/mask]"</span> [invert=<span class="string">"True"</span>]/&gt;</span><br><span class="line">  [ &lt;<span class="built_in">log</span> [prefix=<span class="string">"prefixtext"</span>] [level=<span class="string">"emerg|alert|crit|err|warn|notice|info|debug"</span>]/&gt; [&lt;<span class="built_in">limit</span> value=<span class="string">"rate/duration"</span>/&gt;] &lt;/<span class="built_in">log</span>&gt; ]</span><br><span class="line">  [ &lt;audit&gt; [&lt;<span class="built_in">limit</span> value=<span class="string">"rate/duration"</span>/&gt;] &lt;/audit&gt; ]</span><br><span class="line">  &lt;accept&gt; [&lt;<span class="built_in">limit</span> value=<span class="string">"rate/duration"</span>/&gt;] &lt;/accept&gt; |</span><br><span class="line">  &lt;reject [<span class="built_in">type</span>=<span class="string">"rejecttype"</span>]&gt; [&lt;<span class="built_in">limit</span> value=<span class="string">"rate/duration"</span>/&gt;] &lt;/reject&gt; |</span><br><span class="line">  &lt;drop&gt; [&lt;<span class="built_in">limit</span> value=<span class="string">"rate/duration"</span>/&gt;] &lt;/drop&gt;</span><br><span class="line">&lt;/rule&gt;</span><br></pre></td></tr></table></figure>

<h1 id="services"><a href="#services" class="headerlink" title="services"></a>services</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">service</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">short</span>&gt;</span>MySQL<span class="tag">&lt;/<span class="name">short</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>MySQL Database Server<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"tcp"</span> <span class="attr">port</span>=<span class="string">"3306"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">version=<span class="string">"string"</span></span><br><span class="line">short</span><br><span class="line">description</span><br><span class="line">port</span><br><span class="line">    port=<span class="string">"string"</span></span><br><span class="line">    protocol=<span class="string">"string"</span></span><br><span class="line">protocol</span><br><span class="line">    value=<span class="string">"string"</span></span><br><span class="line"><span class="built_in">source</span>-port</span><br><span class="line">    port=<span class="string">"string"</span></span><br><span class="line">    protocol=<span class="string">"string"</span></span><br><span class="line">module</span><br><span class="line">    name=<span class="string">"string"</span></span><br><span class="line">destination</span><br><span class="line">    ipv4=<span class="string">"address[/mask]"</span></span><br><span class="line">    ipv6=<span class="string">"address[/mask]"</span></span><br></pre></td></tr></table></figure>

<h1 id="ipset-配置"><a href="#ipset-配置" class="headerlink" title="ipset 配置"></a>ipset 配置</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 系统默认没有ipset配置文件，需要手动创建ipset配置文件</span></span><br><span class="line"><span class="comment">mkdir -p /etc/firewalld/ipsets/mytest.xml mytest就是ipset名称</span></span><br><span class="line"><span class="comment">根据官方手册提供的配置模板 --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ipset</span> <span class="attr">type</span>=<span class="string">"hash:net"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">short</span>&gt;</span>white-list<span class="tag">&lt;/<span class="name">short</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span>192.168.1.1<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span>192.168.1.2<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span>192.168.1.3<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ipset</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- entry也就是需要加入的IP地址</span></span><br><span class="line"><span class="comment">firewall-cmd --get-ipsets 显示当前的ipset</span></span><br><span class="line"><span class="comment">firewall-cmd --permanent --add-rich-rule 'rule family="ipv4" source ipset="mytest" port port=80 protocol=tcp accept' 将ipset应用到策略中 --&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h1><ul>
<li>yum -y install firewalld firewall-config #安装 firewalld</li>
<li>systemctl enable|disable firewalld #开机启动</li>
<li>systemctl start|stop|restart firewalld #启动、停止、重启 firewalld</li>
</ul>
<h1 id="如果想使用-iptables-配置防火墙规则，要先安装-iptables-并禁用-firewalld"><a href="#如果想使用-iptables-配置防火墙规则，要先安装-iptables-并禁用-firewalld" class="headerlink" title="如果想使用 iptables 配置防火墙规则，要先安装 iptables 并禁用 firewalld"></a>如果想使用 iptables 配置防火墙规则，要先安装 iptables 并禁用 firewalld</h1><ul>
<li>yum -y install iptables-services #安装 iptables</li>
<li>systemctl enable iptables #开机启动</li>
<li>systemctl start|stop|restart iptables #启动、停止、重启 iptables</li>
</ul>
<h1 id="firewall-cmd-常用命令"><a href="#firewall-cmd-常用命令" class="headerlink" title="firewall-cmd 常用命令"></a>firewall-cmd 常用命令</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --version 查看firewalld版本</span><br><span class="line">firewall-cmd --<span class="built_in">help</span> 查看firewall-cmd用法</span><br><span class="line">man firewall-cmd</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --state <span class="comment">#查看firewalld的状态</span></span><br><span class="line">systemctl status firewalld <span class="comment">#查看firewalld的状态,详细</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload 重新载入防火墙配置，当前连接不中断</span><br><span class="line">firewall-cmd --complete-reload 重新载入防火墙配置，当前连接中断</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --get-services 列出所有预设服务</span><br><span class="line">firewall-cmd --list-services 列出当前服务</span><br><span class="line">firewall-cmd --permanent --zone=public --add-service=smtp 启用服务</span><br><span class="line">firewall-cmd --permanent --zone=public --remove-service=smtp 禁用服务</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --list-ports</span><br><span class="line">firewall-cmd --permanent --zone=public --add-port=8080/tcp 启用端口</span><br><span class="line">firewall-cmd --permanent --zone=public --remove-port=8080/tcp 禁用端口</span><br><span class="line">firewall-cmd --zone=<span class="string">"public"</span> --add-forward-port=port=80:proto=tcp:toport=12345 同服务器端口转发 80端口转发到12345端口</span><br><span class="line">firewall-cmd --zone=public --add-masquerade 不同服务器端口转发，要先开启 masquerade</span><br><span class="line">firewall-cmd --zone=<span class="string">"public"</span> --add-forward-port=port=80:proto=tcp:toport=8080:toaddr=192.168.1.1 不同服务器端口转发，转发到192.168.1.1的8080端口</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --get-zones 查看所有可用区域</span><br><span class="line">firewall-cmd --get-active-zones 查看当前活动的区域,并附带一个目前分配给它们的接口列表</span><br><span class="line">firewall-cmd --list-all-zones 列出所有区域的所有配置</span><br><span class="line">firewall-cmd --zone=work --list-all 列出指定域的所有配置</span><br><span class="line">firewall-cmd --get-default-zone 查看默认区域</span><br><span class="line">firewall-cmd --<span class="built_in">set</span>-default-zone=public 设定默认区域</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --get-zone-of-interface=eno222</span><br><span class="line">firewall-cmd [--zone=&lt;zone&gt;] --add-interface=&lt;interface&gt; 添加网络接口</span><br><span class="line">firewall-cmd [--zone=&lt;zone&gt;] --change-interface=&lt;interface&gt; 修改网络接口</span><br><span class="line">firewall-cmd [--zone=&lt;zone&gt;] --remove-interface=&lt;interface&gt; 删除网络接口</span><br><span class="line">firewall-cmd [--zone=&lt;zone&gt;] --query-interface=&lt;interface&gt; 查询网络接口</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --zone=internal --add-source=192.168.122.0/24 设置网络地址到指定的区域</span><br><span class="line">firewall-cmd --permanent --zone=internal --remove-source=192.168.122.0/24 删除指定区域中的网路地址</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --get-icmptypes</span><br></pre></td></tr></table></figure>

<h1 id="Rich-Rules"><a href="#Rich-Rules" class="headerlink" title="Rich Rules"></a>Rich Rules</h1><ul>
<li>firewall-cmd –list-rich-rules 列出所有规则</li>
<li>firewall-cmd [–zone=zone] –query-rich-rule=’rule’ 检查一项规则是否存在</li>
<li>firewall-cmd [–zone=zone] –remove-rich-rule=’rule’ 移除一项规则</li>
<li>firewall-cmd [–zone=zone] –add -rich-rule=’rule’ 新增一</li>
</ul>
<h2 id="复杂规则配置案例"><a href="#复杂规则配置案例" class="headerlink" title="复杂规则配置案例"></a>复杂规则配置案例</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-rich-rule <span class="string">'rule family="ipv4" source address=192.168.0.14 accept'</span> 允许来自主机 192.168.0.14 的所有 IPv4 流量</span><br><span class="line">firewall-cmd --zone=public --add-rich-rule <span class="string">'rule family="ipv4" source address="192.168.1.10" port port=22 protocol=tcp reject'</span> 拒绝来自主机 192.168.1.10 到 22 端口的 IPv4 的 TCP 流量</span><br><span class="line">firewall-cmd --zone=public --add-rich-rule <span class="string">'rule family=ipv4 source address=10.1.0.3 forward-port port=80 protocol=tcp to-port=6532'</span> 许来自主机 10.1.0.3 到 80 端口的 IPv4 的 TCP 流量，并将流量转发到 6532 端口上</span><br><span class="line">firewall-cmd --zone=public --add-rich-rule <span class="string">'rule family=ipv4 forward-port port=80 protocol=tcp to-port=8080 to-addr=172.31.4.2'</span> 将主机 172.31.4.2 上 80 端口的 IPv4 流量转发到 8080 端口（需要在区域上激活 masquerade）</span><br><span class="line">firewall-cmd --add-rich-rule=<span class="string">'rule family="ipv4" source address="192.168.122.0" accept'</span> 允许192.168.122.0/24主机所有连接</span><br><span class="line">firewall-cmd --add-rich-rule=<span class="string">'rule service name=ftp limit value=2/m accept'</span> 每分钟允许2个新连接访问ftp服务</span><br><span class="line">firewall-cmd --add-rich-rule=<span class="string">'rule service name=ftp log limit value="1/m" audit accept'</span> 同意新的IPv4和IPv6连接FTP ,并使用审核每分钟登录一次</span><br><span class="line">firewall-cmd --add-rich-rule=<span class="string">'rule family="ipv4" source address="192.168.122.0/24" service name=ssh log prefix="ssh" level="notice" limit value="3/m" accept'</span> 允许来自1192.168.122.0/24地址的新IPv4连接连接TFTP服务,并且每分钟记录一次</span><br><span class="line">firewall-cmd --permanent --add-rich-rule=<span class="string">'rule protocol value=icmp drop'</span> 丢弃所有icmp包</span><br><span class="line">firewall-cmd --add-rich-rule=<span class="string">'rule family=ipv4 source address=192.168.122.0/24 reject'</span> --timeout=10 当使用<span class="built_in">source</span>和destination指定地址时,必须有family参数指定ipv4或ipv6。如果指定超时,规则将在指定的秒数内被激活,并在之后被自动移除</span><br><span class="line">firewall-cmd --add-rich-rule=<span class="string">'rule family=ipv6 source address="2001:db8::/64" service name="dns" audit limit value="1/h" reject'</span> --timeout=300 拒绝所有来自2001:db8::/64子网的主机访问dns服务,并且每小时只审核记录1次日志</span><br><span class="line">firewall-cmd --permanent --add-rich-rule=<span class="string">'rule family=ipv4 source address=192.168.122.0/24 service name=ftp accept'</span> 允许192.168.122.0/24网段中的主机访问ftp服务</span><br><span class="line">firewall-cmd --add-rich-rule=<span class="string">'rule family="ipv6" source address="1:2:3:4:6::" forward-portto-addr="1::2:3:4:7" to-port="4012" protocol="tcp" port="4011"'</span> 转发来自ipv6地址1:2:3:4:6::TCP端口4011,到1:2:3:4:7的TCP端口4012</span><br></pre></td></tr></table></figure>

<h1 id="Direct-Rules"><a href="#Direct-Rules" class="headerlink" title="Direct Rules"></a>Direct Rules</h1><ul>
<li>firewall-cmd –direct –add-rule ipv4 filter IN_public_allow 0 -p tcp –dport 80 -j ACCEPT 添加规则</li>
<li>firewall-cmd –direct –remove-rule ipv4 filter IN_public_allow 10 -p tcp –dport 80 -j ACCEPT 删除规则</li>
<li>firewall-cmd –direct –get-all-rules 列出规则</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swiftist.cn/2020/01/13/centos/CentOs7-%E9%98%B2%E7%81%AB%E5%A2%99firewalld%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Andy Ge">
      <meta itemprop="description" content="勇于积极进取，步入人生的世外桃源">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="飞雪轩辕">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/13/centos/CentOs7-%E9%98%B2%E7%81%AB%E5%A2%99firewalld%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">CentOs7 防火墙firewalld基本使用方法</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-13 15:49:10" itemprop="dateCreated datePublished" datetime="2020-01-13T15:49:10+08:00">2020-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-31 23:07:39" itemprop="dateModified" datetime="2020-03-31T23:07:39+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/centos/" itemprop="url" rel="index">
                    <span itemprop="name">centos</span>
                  </a>
                </span>
            </span>

          
            <span id="/2020/01/13/centos/CentOs7-%E9%98%B2%E7%81%AB%E5%A2%99firewalld%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/" class="post-meta-item leancloud_visitors" data-flag-title="CentOs7 防火墙firewalld基本使用方法" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>firewalld 的基本使用</li>
</ol>
<ul>
<li>启动： systemctl start firewalld</li>
<li>查看状态： systemctl status firewalld</li>
<li>停止： systemctl disable firewalld</li>
<li>禁用： systemctl stop firewalld</li>
</ul>
<ol start="2">
<li>systemctl 是 CentOS7 的服务管理工具中主要的工具，它融合之前 service 和 chkconfig 的功能于一体。</li>
</ol>
<ul>
<li>启动一个服务：systemctl start firewalld.service</li>
<li>关闭一个服务：systemctl stop firewalld.service</li>
<li>重启一个服务：systemctl restart firewalld.service</li>
<li>显示一个服务的状态：systemctl status firewalld.service</li>
<li>在开机时启用一个服务：systemctl enable firewalld.service</li>
<li>在开机时禁用一个服务：systemctl disable firewalld.service</li>
<li>查看服务是否开机启动：systemctl is-enabled firewalld.service</li>
<li>查看已启动的服务列表：systemctl list-unit-files|grep enabled</li>
<li>查看启动失败的服务列表：systemctl –failed</li>
</ul>
<ol start="3">
<li>配置 firewalld-cmd</li>
</ol>
<ul>
<li>查看版本： firewall-cmd –version</li>
<li>查看帮助： firewall-cmd –help</li>
<li>显示状态： firewall-cmd –state</li>
<li>查看所有打开的端口： firewall-cmd –zone=public –list-ports</li>
<li>更新防火墙规则： firewall-cmd –reload</li>
<li>查看区域信息: firewall-cmd –get-active-zones</li>
<li>查看指定接口所属区域： firewall-cmd –get-zone-of-interface=eth0</li>
<li>拒绝所有包：firewall-cmd –panic-on</li>
<li>取消拒绝状态： firewall-cmd –panic-off</li>
<li>查看是否拒绝： firewall-cmd –query-panic</li>
</ul>
<ol start="4">
<li>那怎么开启一个端口呢</li>
</ol>
<ul>
<li>添加： firewall-cmd –zone=public –add-port=80/tcp –permanent （–permanent 永久生效，没有此参数重启后失效）</li>
<li>重新载入： firewall-cmd –reload</li>
<li>查看： firewall-cmd –zone= public –query-port=80/tcp</li>
<li>删除： firewall-cmd –zone= public –remove-port=80/tcp –permanent</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swiftist.cn/2020/01/13/linux/Linux-firewalld-%E9%98%B2%E7%81%AB%E5%A2%99%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Andy Ge">
      <meta itemprop="description" content="勇于积极进取，步入人生的世外桃源">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="飞雪轩辕">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/13/linux/Linux-firewalld-%E9%98%B2%E7%81%AB%E5%A2%99%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Linux firewalld 防火墙使用</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-13 15:35:43" itemprop="dateCreated datePublished" datetime="2020-01-13T15:35:43+08:00">2020-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-31 23:07:39" itemprop="dateModified" datetime="2020-03-31T23:07:39+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>
            </span>

          
            <span id="/2020/01/13/linux/Linux-firewalld-%E9%98%B2%E7%81%AB%E5%A2%99%E4%BD%BF%E7%94%A8/" class="post-meta-item leancloud_visitors" data-flag-title="Linux firewalld 防火墙使用" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h1><h2 id="firewall-简述"><a href="#firewall-简述" class="headerlink" title="firewall 简述"></a>firewall 简述</h2><ul>
<li>Centos7 默认的防火墙是 firewall，替代了以前的 iptables</li>
<li>firewall 使用更加方便、功能也更加强大一些</li>
<li>firewalld 服务引入了一个信任级别的概念来管理与之相关联的连接与接口。它支持 ipv4 与 ipv6，并支持网桥，采用 firewall-cmd (command) 或 firewall-config (gui) 来动态的管理 kernel netfilter 的临时或永久的接口规则，并实时生效而无需重启服务。</li>
</ul>
<h2 id="firewall-版本"><a href="#firewall-版本" class="headerlink" title="firewall 版本"></a>firewall 版本</h2><ul>
<li>查看版本：<code>firewall-cmd --version</code></li>
</ul>
<h2 id="firewall-安装"><a href="#firewall-安装" class="headerlink" title="firewall 安装"></a>firewall 安装</h2><ul>
<li>像使用 iptables 一样，firewall 同样需要安装</li>
<li>需要注意的是某些系统已经自带了 firewall 的，如果查看版本没有找到，则可以进行 yun 安装</li>
<li>安装指令： <code>yum install firewalld</code></li>
</ul>
<h2 id="firewalld-基本使用"><a href="#firewalld-基本使用" class="headerlink" title="firewalld 基本使用"></a>firewalld 基本使用</h2><ul>
<li>firewall 与 iptables 一样都是服务，所以可以使用 systemctl 服务管理工具来操作</li>
<li>查看 firewall 服务状态： <code>systemctl status firewalld</code></li>
<li>停止 firewall 服务：<code>systemctl stop firewalld</code></li>
<li>启动 firewall 服务：<code>systemctl start firewalld</code></li>
<li>重启 firewall 服务：<code>systemctl restart firewalld</code></li>
<li>查看 firewall 服务是否开机启动：<code>systemctl is-enabled firewalld</code></li>
<li>开机时启动 firewall 服务：<code>systemctl enable firewalld.service</code></li>
<li>开机时禁用 firewall 服务：<code>systemctl disable firewalld.service</code></li>
</ul>
<h2 id="firewalld-cmd-基本使用"><a href="#firewalld-cmd-基本使用" class="headerlink" title="firewalld-cmd 基本使用"></a>firewalld-cmd 基本使用</h2><ul>
<li>上面所说的 firewall 可以看成整个防火墙服务，而 firewall-cmd 可以看成是其中的一个功能，可用来管理端口<br>查看  firewall-cmd 状态</li>
<li>查看 firewall 状态，即查看 firewall 防火墙程序是否正在运行： <code>firewall-cmd --state</code></li>
<li>查看所有已经打开的端口： <code>firewall-cmd --zone=public --list-ports</code></li>
<li>开启一个端口：<code>firewall-cmd --zone=public --add-port=80/tcp --permanent</code>    （–permanent 永久生效，没有此参数重启后失效）</li>
<li>重新加载 firewall，修改配置后，必须重新加载才能生效：<code>firewall-cmd --reload</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示public区域开放的端口</span></span><br><span class="line">firewall-cmd --zone=public --list-port</span><br><span class="line">9876/tcp 8090/tcp 80/tcp 8080/tcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加端口</span></span><br><span class="line">firewall-cmd --zone=public --add-port=3307/tcp --permanent</span><br><span class="line">success</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载应用配置</span></span><br><span class="line">firewall-cmd --reload</span><br><span class="line">success</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示启用的端口</span></span><br><span class="line">firewall-cmd --zone=public --list-port</span><br><span class="line">9876/tcp 8090/tcp 80/tcp 8080/tcp 3307/tcp</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭指定端口：<code>firewall-cmd --zone=public --remove-port=9898/tcp --permanent</code>（–permanent 表示永久生效，没有此参数重启后失效）</li>
<li>重新加载 firewall，修改配置后，必须重新加载才能生效：<code>firewall-cmd --reload</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示端口</span></span><br><span class="line">firewall-cmd --zone=public --list-ports</span><br><span class="line">9876/tcp 8090/tcp 80/tcp 8080/tcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久删除端口</span></span><br><span class="line">firewall-cmd --zone=public --remove-port=9876/tcp --permanent</span><br><span class="line">success</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新应用配置</span></span><br><span class="line">firewall-cmd --reload</span><br><span class="line">success</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示开放的端口</span></span><br><span class="line">firewall-cmd --zone=public --list-ports</span><br><span class="line">8090/tcp 80/tcp 8080/tcp</span><br></pre></td></tr></table></figure>

<h2 id="修改文件操作端口"><a href="#修改文件操作端口" class="headerlink" title="修改文件操作端口"></a>修改文件操作端口</h2><ul>
<li>firewall-cmd 对端口的操作，如开放端口等信息，都放在在”/etc/firewall/zones/public.xml”中记录</li>
<li>所以直接修改此文件也是可以的</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">zone</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">short</span>&gt;</span>Public<span class="tag">&lt;/<span class="name">short</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>For use in public areas. You do not trust the other computers on networks to not harm your computer. Only selected incoming connections are accepted.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"ssh"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"dhcpv6-client"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"https"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"tcp"</span> <span class="attr">port</span>=<span class="string">"80"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"tcp"</span> <span class="attr">port</span>=<span class="string">"3308"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"tcp"</span> <span class="attr">port</span>=<span class="string">"6666"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"tcp"</span> <span class="attr">port</span>=<span class="string">"5672"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"tcp"</span> <span class="attr">port</span>=<span class="string">"15672"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"tcp"</span> <span class="attr">port</span>=<span class="string">"443"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">zone</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/73/">73</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Andy Ge</p>
  <div class="site-description" itemprop="description">勇于积极进取，步入人生的世外桃源</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">728</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">134</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">315</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/andyge" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;andyge" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:geshaofei@126.com" title="E-Mail → mailto:geshaofei@126.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://www.ruanyifeng.com/" title="http:&#x2F;&#x2F;www.ruanyifeng.com&#x2F;" rel="noopener" target="_blank">阮一峰</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://colobu.com/" title="http:&#x2F;&#x2F;colobu.com&#x2F;" rel="noopener" target="_blank">鸟窝</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.cnblogs.com/hellokuangshen/" title="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;hellokuangshen&#x2F;" rel="noopener" target="_blank">狂神</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://yelog.org/" title="https:&#x2F;&#x2F;yelog.org&#x2F;" rel="noopener" target="_blank">叶落阁</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Andy Ge</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.1
  </div>

        






  <script>
  function leancloudSelector(url) {
    url = encodeURI(url);
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.getAttribute('id'));
      var title = visitors.getAttribute('data-flag-title');

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .then(() => {
                leancloudSelector(url).innerText = counter.time + 1;
              })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              })
          } else {
              Counter('post', '/classes/Counter', { title: title, url: url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.getAttribute('id'));
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (let item of results) {
            let { url, time } = item;
            leancloudSelector(url).innerText = time;
          }
          for (let url of entries) {
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=2TdIb5gRlAVUw24l2W0zWnCj-gzGzoHsz')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method: method,
          headers: {
            'X-LC-Id'     : '2TdIb5gRlAVUw24l2W0zWnCj-gzGzoHsz',
            'X-LC-Key'    : 'cJdJrMLBXsj0ttq0WsL0aA2j',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });
  </script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
